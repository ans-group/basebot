"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;
var _awsSdk = require("aws-sdk");
var _mapValues = _interopRequireDefault(require("lodash/mapValues"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };} // based on https://github.com/joshuahoover/botkit-storage-dynamodb/blob/master/src/index.js
var _default =
function _default() {var logger = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : function () {return console.log;};
  var debug = logger('services:storage:dynamoDB', 'debug');
  var error = logger('services:storage:dynamoDB', 'error');

  if (!process.env.AWS_REGION || !process.env.AWS_SECRET_ACCESS_KEY || !process.env.AWS_ACCESS_KEY_ID) {
    error('AWS_REGION, AWS_SECRET_ACCESS_KEY and AWS_ACCESS_KEY_ID are required');
  }
  var params = { region: process.env.AWS_REGION };
  if (process.env.NODE_ENV !== 'production') {
    params.endpoint = 'http://localhost:8000';
  }
  var db = new _awsSdk.DynamoDB(params);
  var storage = {};
  var keys = ['teams', 'channels', 'users', 'responses'];
  keys.forEach(function (type) {
    var dynamoTable = type === 'responses' ? 'response' : type;
    storage[type] = getStorage(db, dynamoTable);
  });

  function getStorage(db, table) {
    return {
      get: function get(hash) {return new Promise(function (resolve, reject) {
          debug('fetching doc with hash: ', hash, ' from ', table);
          var cb = function cb(err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            debug('Response received: ', res);var
            Item = res.Item;
            if (!Item) {// no result found
              resolve(null);
            } else {// result found
              resolve((0, _mapValues["default"])(Item, cleanRes));
            }
          };
          if (table === 'response') {
            db.getItem({
              TableName: table,
              Key: {
                intentName: {
                  S: hash } } },


            cb);
          } else {
            db.getItem({
              TableName: table,
              Key: {
                _id: {
                  S: hash } } },


            cb);
          }
        });},

      save: function save(data) {return new Promise(function (resolve, reject) {
          debug('saving doc with data: ', data);
          db.putItem({
            TableName: table,
            Item: (0, _mapValues["default"])(data, function (value) {return {
                S: value };}) },

          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            res = res || {};
            resolve(res);
          });
        });},

      all: function all() {return new Promise(function (resolve, reject) {
          debug('fetching all docs');
          db.scan({
            TableName: table },
          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            var items = res.Items || [];
            resolve((0, _mapValues["default"])(items, cleanRes));
          });
        });} };

  }

  function cleanRes(value) {
    return Object.values(value)[0];
  }

  return storage;
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImNvbnNvbGUiLCJsb2ciLCJkZWJ1ZyIsImVycm9yIiwicHJvY2VzcyIsImVudiIsIkFXU19SRUdJT04iLCJBV1NfU0VDUkVUX0FDQ0VTU19LRVkiLCJBV1NfQUNDRVNTX0tFWV9JRCIsInBhcmFtcyIsInJlZ2lvbiIsIk5PREVfRU5WIiwiZW5kcG9pbnQiLCJkYiIsIkR5bmFtb0RCIiwic3RvcmFnZSIsImtleXMiLCJmb3JFYWNoIiwidHlwZSIsImR5bmFtb1RhYmxlIiwiZ2V0U3RvcmFnZSIsInRhYmxlIiwiZ2V0IiwiaGFzaCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiY2IiLCJlcnIiLCJyZXMiLCJJdGVtIiwiY2xlYW5SZXMiLCJnZXRJdGVtIiwiVGFibGVOYW1lIiwiS2V5IiwiaW50ZW50TmFtZSIsIlMiLCJfaWQiLCJzYXZlIiwiZGF0YSIsInB1dEl0ZW0iLCJ2YWx1ZSIsImFsbCIsInNjYW4iLCJpdGVtcyIsIkl0ZW1zIiwiT2JqZWN0IiwidmFsdWVzIl0sIm1hcHBpbmdzIjoiO0FBQ0E7QUFDQSxxRSxnR0FGQTs7QUFJZSxvQkFBZ0MsS0FBL0JBLE1BQStCLHVFQUF0QixvQkFBTUMsT0FBTyxDQUFDQyxHQUFkLEVBQXNCO0FBQzdDLE1BQU1DLEtBQUssR0FBR0gsTUFBTSxDQUFDLDJCQUFELEVBQThCLE9BQTlCLENBQXBCO0FBQ0EsTUFBTUksS0FBSyxHQUFHSixNQUFNLENBQUMsMkJBQUQsRUFBOEIsT0FBOUIsQ0FBcEI7O0FBRUEsTUFBSSxDQUFDSyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsVUFBYixJQUEyQixDQUFDRixPQUFPLENBQUNDLEdBQVIsQ0FBWUUscUJBQXhDLElBQWlFLENBQUNILE9BQU8sQ0FBQ0MsR0FBUixDQUFZRyxpQkFBbEYsRUFBcUc7QUFDbkdMLElBQUFBLEtBQUssQ0FBQyxzRUFBRCxDQUFMO0FBQ0Q7QUFDRCxNQUFNTSxNQUFNLEdBQUcsRUFBQ0Ms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YWhvb3Zlci9ib3RraXQtc3RvcmFnZS1keW5hbW9kYi9ibG9iL21hc3Rlci9zcmMvaW5kZXguanNcbmltcG9ydCB7IER5bmFtb0RCIH0gZnJvbSAnYXdzLXNkaydcbmltcG9ydCBtYXBWYWx1ZXMgZnJvbSAnbG9kYXNoL21hcFZhbHVlcydcblxuZXhwb3J0IGRlZmF1bHQgKGxvZ2dlciA9ICgpID0+IGNvbnNvbGUubG9nKSA9PiB7XG4gIGNvbnN0IGRlYnVnID0gbG9nZ2VyKCdzZXJ2aWNlczpzdG9yYWdlOmR5bmFtb0RCJywgJ2RlYnVnJylcbiAgY29uc3QgZXJyb3IgPSBsb2dnZXIoJ3NlcnZpY2VzOnN0b3JhZ2U6ZHluYW1vREInLCAnZXJyb3InKVxuXG4gIGlmICghcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAhcHJvY2Vzcy5lbnYuQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZIHx8ICFwcm9jZXNzLmVudi5BV1NfQUNDRVNTX0tFWV9JRCkge1xuICAgIGVycm9yKCdBV1NfUkVHSU9OLCBBV1NfU0VDUkVUX0FDQ0VTU19LRVkgYW5kIEFXU19BQ0NFU1NfS0VZX0lEIGFyZSByZXF1aXJlZCcpXG4gIH1cbiAgY29uc3QgcGFyYW1zID0ge3JlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTn1cbiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHtcbiAgICAgIHBhcmFtcy5lbmRwb2ludCA9ICdodHRwOi8vbG9jYWxob3N0OjgwMDAnXG4gIH1cbiAgY29uc3QgZGIgPSBuZXcgRHluYW1vREIocGFyYW1zKVxuICBjb25zdCBzdG9yYWdlID0ge31cbiAgY29uc3Qga2V5cyA9IFsndGVhbXMnLCAnY2hhbm5lbHMnLCAndXNlcnMnLCAncmVzcG9uc2VzJ11cbiAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7XG4gICAgY29uc3QgZHluYW1vVGFibGUgPSB0eXBlID09PSAncmVzcG9uc2VzJyA/ICdyZXNwb25zZScgOiB0eXBlXG4gICAgc3RvcmFnZVt0eXBlXSA9IGdldFN0b3JhZ2UoZGIsIGR5bmFtb1RhYmxlKVxuICB9KVxuXG4gIGZ1bmN0aW9uIGdldFN0b3JhZ2UgKGRiLCB0YWJsZSkge1xuICAgIHJldHVybiB7XG4gICAgICBnZXQ6IGhhc2ggPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBkZWJ1ZygnZmV0Y2hpbmcgZG9jIHdpdGggaGFzaDogJywgaGFzaCwgJyBmcm9tICcsIHRhYmxlKVxuICAgICAgICBjb25zdCBjYiA9IChlcnIsIHJlcykgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGVycm9yKGVycilcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgICBkZWJ1ZygnUmVzcG9uc2UgcmVjZWl2ZWQ6ICcsIHJlcylcbiAgICAgICAgICBjb25zdCB7SXRlbX0gPSByZXNcbiAgICAgICAgICBpZiAoIUl0ZW0pIHsgLy8gbm8gcmVzdWx0IGZvdW5kXG4gICAgICAgICAgICByZXNvbHZlKG51bGwpXG4gICAgICAgICAgfSBlbHNlIHsgLy8gcmVzdWx0IGZvdW5kXG4gICAgICAgICAgICByZXNvbHZlKG1hcFZhbHVlcyhJdGVtLCBjbGVhblJlcykpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0YWJsZSA9PT0gJ3Jlc3BvbnNlJykge1xuICAgICAgICAgIGRiLmdldEl0ZW0oe1xuICAgICAgICAgICAgVGFibGVOYW1lOiB0YWJsZSxcbiAgICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgICBpbnRlbnROYW1lOiB7XG4gICAgICAgICAgICAgICAgUzogaGFzaFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSwgY2IpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGIuZ2V0SXRlbSh7XG4gICAgICAgICAgICBUYWJsZU5hbWU6IHRhYmxlLFxuICAgICAgICAgICAgS2V5OiB7XG4gICAgICAgICAgICAgIF9pZDoge1xuICAgICAgICAgICAgICAgIFM6IGhhc2hcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sIGNiKVxuICAgICAgICB9XG4gICAgICB9KSxcblxuICAgICAgc2F2ZTogZGF0YSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGRlYnVnKCdzYXZpbmcgZG9jIHdpdGggZGF0YTogJywgZGF0YSlcbiAgICAgICAgZGIucHV0SXRlbSh7XG4gICAgICAgICAgVGFibGVOYW1lOiB0YWJsZSxcbiAgICAgICAgICBJdGVtOiBtYXBWYWx1ZXMoZGF0YSwgdmFsdWUgPT4gKHtcbiAgICAgICAgICAgIFM6IHZhbHVlXG4gICAgICAgICAgfSkpXG4gICAgICAgIH0sIChlcnIsIHJlcykgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGVycm9yKGVycilcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXMgPSByZXMgfHwge31cbiAgICAgICAgICByZXNvbHZlKHJlcylcbiAgICAgICAgfSlcbiAgICAgIH0pLFxuXG4gICAgICBhbGw6ICgpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgZGVidWcoJ2ZldGNoaW5nIGFsbCBkb2NzJylcbiAgICAgICAgZGIuc2Nhbih7XG4gICAgICAgICAgVGFibGVOYW1lOiB0YWJsZVxuICAgICAgICB9LCAoZXJyLCByZXMpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBlcnJvcihlcnIpXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycilcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgaXRlbXMgPSByZXMuSXRlbXMgfHwgW11cbiAgICAgICAgICByZXNvbHZlKG1hcFZhbHVlcyhpdGVtcywgY2xlYW5SZXMpKVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBjbGVhblJlcyAodmFsdWUpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh2YWx1ZSlbMF1cbiAgfVxuXG4gIHJldHVybiBzdG9yYWdlXG59XG4iXX0=