"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;
var _awsSdk = require("aws-sdk");
var _mapValues = _interopRequireDefault(require("lodash/mapValues"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };} // based on https://github.com/joshuahoover/botkit-storage-dynamodb/blob/master/src/index.js
var _default =
function _default() {var logger = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : function () {return console.log;};
  var debug = logger('services:storage:dynamoDB', 'debug');
  var error = logger('services:storage:dynamoDB', 'error');

  if (!process.env.AWS_REGION || !process.env.AWS_SECRET_ACCESS_KEY || !process.env.AWS_ACCESS_KEY_ID) {
    error('AWS_REGION, AWS_SECRET_ACCESS_KEY and AWS_ACCESS_KEY_ID are required');
  }
  var params = { region: process.env.AWS_REGION };
  if (process.env.NODE_ENV !== 'production') {
    params.endpoint = 'http://localhost:8000';
  }
  var db = new _awsSdk.DynamoDB(params);
  var storage = {};
  var keys = ['teams', 'channels', 'users', 'responses'];
  keys.forEach(function (type) {
    var dynamoTable = type === 'responses' ? 'response' : type;
    storage[type] = getStorage(db, dynamoTable);
  });

  function getStorage(db, table) {
    return {
      get: function get(hash) {return new Promise(function (resolve, reject) {
          debug('fetching doc with hash: ', hash, ' from ', table);
          var cb = function cb(err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            debug('Response received: ', res);
            var items = res.Items || [];
            if (items.length === 0) {// no result found
              resolve(null);
            } else {// result found
              resolve((0, _mapValues["default"])(items[0], cleanRes));
            }
          };
          if (table === 'responses') {
            db.getItem({
              TableName: table,
              Key: {
                intentName: {
                  S: hash } } },


            cb);
          } else {
            db.getItem({
              TableName: table,
              Key: {
                _id: {
                  S: hash } } },


            cb);
          }
        });},

      save: function save(data) {return new Promise(function (resolve, reject) {
          debug('saving doc with data: ', data);
          db.putItem({
            TableName: table,
            Item: (0, _mapValues["default"])(data, function (value) {return {
                S: value };}) },

          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            res = res || {};
            resolve(res);
          });
        });},

      all: function all() {return new Promise(function (resolve, reject) {
          debug('fetching all docs');
          db.scan({
            TableName: table },
          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            var items = res.Items || [];
            resolve((0, _mapValues["default"])(items, cleanRes));
          });
        });} };

  }

  function cleanRes(value) {
    return Object.values(value)[0];
  }

  return storage;
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImNvbnNvbGUiLCJsb2ciLCJkZWJ1ZyIsImVycm9yIiwicHJvY2VzcyIsImVudiIsIkFXU19SRUdJT04iLCJBV1NfU0VDUkVUX0FDQ0VTU19LRVkiLCJBV1NfQUNDRVNTX0tFWV9JRCIsInBhcmFtcyIsInJlZ2lvbiIsIk5PREVfRU5WIiwiZW5kcG9pbnQiLCJkYiIsIkR5bmFtb0RCIiwic3RvcmFnZSIsImtleXMiLCJmb3JFYWNoIiwidHlwZSIsImR5bmFtb1RhYmxlIiwiZ2V0U3RvcmFnZSIsInRhYmxlIiwiZ2V0IiwiaGFzaCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiY2IiLCJlcnIiLCJyZXMiLCJpdGVtcyIsIkl0ZW1zIiwibGVuZ3RoIiwiY2xlYW5SZXMiLCJnZXRJdGVtIiwiVGFibGVOYW1lIiwiS2V5IiwiaW50ZW50TmFtZSIsIlMiLCJfaWQiLCJzYXZlIiwiZGF0YSIsInB1dEl0ZW0iLCJJdGVtIiwidmFsdWUiLCJhbGwiLCJzY2FuIiwiT2JqZWN0IiwidmFsdWVzIl0sIm1hcHBpbmdzIjoiO0FBQ0E7QUFDQSxxRSxnR0FGQTs7QUFJZSxvQkFBZ0MsS0FBL0JBLE1BQStCLHVFQUF0QixvQkFBTUMsT0FBTyxDQUFDQyxHQUFkLEVBQXNCO0FBQzdDLE1BQU1DLEtBQUssR0FBR0gsTUFBTSxDQUFDLDJCQUFELEVBQThCLE9BQTlCLENBQXBCO0FBQ0EsTUFBTUksS0FBSyxHQUFHSixNQUFNLENBQUMsMkJBQUQsRUFBOEIsT0FBOUIsQ0FBcEI7O0FBRUEsTUFBSSxDQUFDSyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsVUFBYixJQUEyQixDQUFDRixPQUFPLENBQUNDLEdBQVIsQ0FBWUUscUJBQXhDLElBQWlFLENBQUNILE9BQU8sQ0FBQ0MsR0FBUixDQUFZRyxpQkFBbEYsRUFBcUc7QUFDbkdMLElBQUFBLEtBQUssQ0FBQyxzRUFBRCxDQUFMO0FBQ0Q7QUFDRCxNQUFNTSxNQUFNLEdBQUcsRUFBQ0MsTUFBTSxFQUFFTixPQUFPLENBQUNDLEdBQVIsQ0FBWUMsVUFBckIsRUFBZjtBQUNBLE1BQUlGLE9BQU8sQ0FBQ0MsR0FBUixDQUFZTSxRQUFaLEtBQXlCLFlBQTdCLEVBQTJDO0FBQ3ZDRixJQUFBQSxNQUFNLENBQUNHLFFBQVAsR0FBa0IsdUJBQWxCO0FBQ0g7QUFDRCxNQUFNQyxFQUFFLEdBQUcsSUFBSUMsZ0JBQUosQ0FBYUwsTUFBYixDQUFYO0FBQ0EsTUFBTU0sT0FBTyxHQUFHLEVBQWhCO0FBQ0EsTUFBTUMsSUFBSSxHQUFHLENBQUMsT0FBRCxFQUFVLFVBQVYsRUFBc0IsT0FBdEIsRUFBK0IsV0FBL0IsQ0FBYjtBQUNBQSxFQUFBQSxJQUFJLENBQUNDLE9BQUwsQ0FBYSxVQUFVQyxJQUFWLEVBQWdCO0FBQzNCLFFBQU1DLFdBQVcsR0FBR0QsSUFBSSxLQUFLLFdBQVQsR0FBdUIsVUFBdkIsR0FBb0NBLElBQXhEO0FBQ0FILElBQUFBLE9BQU8sQ0FBQ0csSUFBRCxDQUFQLEdBQWdCRSxVQUFVLENBQUNQLEVBQUQsRUFBS00sV0FBTCxDQUExQjtBQUNELEdBSEQ7O0FBS0EsV0FBU0MsVUFBVCxDQUFxQlAsRUFBckIsRUFBeUJRLEtBQXpCLEVBQWdDO0FBQzlCLFdBQU87QUFDTEMsTUFBQUEsR0FBRyxFQUFFLGFBQUFDLElBQUksVUFBSSxJQUFJQyxPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQzVDeEIsVUFBQUEsS0FBSyxDQUFDLDBCQUFELEVBQTZCcUIsSUFBN0IsRUFBbUMsUUFBbkMsRUFBNkNGLEtBQTdDLENBQUw7QUFDQSxjQUFNTSxFQUFFLEdBQUcsU0FBTEEsRUFBSyxDQUFDQyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUN2QixnQkFBSUQsR0FBSixFQUFTO0FBQ1B6QixjQUFBQSxLQUFLLENBQUN5QixHQUFELENBQUw7QUFDQSxxQkFBT0YsTUFBTSxDQUFDRSxHQUFELENBQWI7QUFDRDtBQUNEMUIsWUFBQUEsS0FBSyxDQUFDLHFCQUFELEVBQXdCMkIsR0FBeEIsQ0FBTDtBQUNBLGdCQUFNQyxLQUFLLEdBQUdELEdBQUcsQ0FBQ0UsS0FBSixJQUFhLEVBQTNCO0FBQ0EsZ0JBQUlELEtBQUssQ0FBQ0UsTUFBTixLQUFpQixDQUFyQixFQUF3QixDQUFFO0FBQ3hCUCxjQUFBQSxPQUFPLENBQUMsSUFBRCxDQUFQO0FBQ0QsYUFGRCxNQUVPLENBQUU7QUFDUEEsY0FBQUEsT0FBTyxDQUFDLDJCQUFVSyxLQUFLLENBQUMsQ0FBRCxDQUFmLEVBQW9CRyxRQUFwQixDQUFELENBQVA7QUFDRDtBQUNGLFdBWkQ7QUFhQSxjQUFJWixLQUFLLEtBQUssV0FBZCxFQUEyQjtBQUN6QlIsWUFBQUEsRUFBRSxDQUFDcUIsT0FBSCxDQUFXO0FBQ1RDLGNBQUFBLFNBQVMsRUFBRWQsS0FERjtBQUVUZSxjQUFBQSxHQUFHLEVBQUU7QUFDSEMsZ0JBQUFBLFVBQVUsRUFBRTtBQUNWQyxrQkFBQUEsQ0FBQyxFQUFFZixJQURPLEVBRFQsRUFGSSxFQUFYOzs7QUFPR0ksWUFBQUEsRUFQSDtBQVFELFdBVEQsTUFTTztBQUNMZCxZQUFBQSxFQUFFLENBQUNxQixPQUFILENBQVc7QUFDVEMsY0FBQUEsU0FBUyxFQUFFZCxLQURGO0FBRVRlLGNBQUFBLEdBQUcsRUFBRTtBQUNIRyxnQkFBQUEsR0FBRyxFQUFFO0FBQ0hELGtCQUFBQSxDQUFDLEVBQUVmLElBREEsRUFERixFQUZJLEVBQVg7OztBQU9HSSxZQUFBQSxFQVBIO0FBUUQ7QUFDRixTQWxDWSxDQUFKLEVBREo7O0FBcUNMYSxNQUFBQSxJQUFJLEVBQUUsY0FBQUMsSUFBSSxVQUFJLElBQUlqQixPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQzdDeEIsVUFBQUEsS0FBSyxDQUFDLHdCQUFELEVBQTJCdUMsSUFBM0IsQ0FBTDtBQUNBNUIsVUFBQUEsRUFBRSxDQUFDNkIsT0FBSCxDQUFXO0FBQ1RQLFlBQUFBLFNBQVMsRUFBRWQsS0FERjtBQUVUc0IsWUFBQUEsSUFBSSxFQUFFLDJCQUFVRixJQUFWLEVBQWdCLFVBQUFHLEtBQUssVUFBSztBQUM5Qk4sZ0JBQUFBLENBQUMsRUFBRU0sS0FEMkIsRUFBTCxFQUFyQixDQUZHLEVBQVg7O0FBS0csb0JBQUNoQixHQUFELEVBQU1DLEdBQU4sRUFBYztBQUNmLGdCQUFJRCxHQUFKLEVBQVM7QUFDUHpCLGNBQUFBLEtBQUssQ0FBQ3lCLEdBQUQsQ0FBTDtBQUNBLHFCQUFPRixNQUFNLENBQUNFLEdBQUQsQ0FBYjtBQUNEO0FBQ0RDLFlBQUFBLEdBQUcsR0FBR0EsR0FBRyxJQUFJLEVBQWI7QUFDQUosWUFBQUEsT0FBTyxDQUFDSSxHQUFELENBQVA7QUFDRCxXQVpEO0FBYUQsU0FmYSxDQUFKLEVBckNMOztBQXNETGdCLE1BQUFBLEdBQUcsRUFBRSx1QkFBTSxJQUFJckIsT0FBSixDQUFZLFVBQUNDLE9BQUQsRUFBVUMsTUFBVixFQUFxQjtBQUMxQ3hCLFVBQUFBLEtBQUssQ0FBQyxtQkFBRCxDQUFMO0FBQ0FXLFVBQUFBLEVBQUUsQ0FBQ2lDLElBQUgsQ0FBUTtBQUNOWCxZQUFBQSxTQUFTLEVBQUVkLEtBREwsRUFBUjtBQUVHLG9CQUFDTyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUNmLGdCQUFJRCxHQUFKLEVBQVM7QUFDUHpCLGNBQUFBLEtBQUssQ0FBQ3lCLEdBQUQsQ0FBTDtBQUNBLHFCQUFPRixNQUFNLENBQUNFLEdBQUQsQ0FBYjtBQUNEO0FBQ0QsZ0JBQU1FLEtBQUssR0FBR0QsR0FBRyxDQUFDRSxLQUFKLElBQWEsRUFBM0I7QUFDQU4sWUFBQUEsT0FBTyxDQUFDLDJCQUFVSyxLQUFWLEVBQWlCRyxRQUFqQixDQUFELENBQVA7QUFDRCxXQVREO0FBVUQsU0FaVSxDQUFOLEVBdERBLEVBQVA7O0FBb0VEOztBQUVELFdBQVNBLFFBQVQsQ0FBbUJXLEtBQW5CLEVBQTBCO0FBQ3hCLFdBQU9HLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjSixLQUFkLEVBQXFCLENBQXJCLENBQVA7QUFDRDs7QUFFRCxTQUFPN0IsT0FBUDtBQUNELEMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBiYXNlZCBvbiBodHRwczovL2dpdGh1Yi5jb20vam9zaHVhaG9vdmVyL2JvdGtpdC1zdG9yYWdlLWR5bmFtb2RiL2Jsb2IvbWFzdGVyL3NyYy9pbmRleC5qc1xuaW1wb3J0IHsgRHluYW1vREIgfSBmcm9tICdhd3Mtc2RrJ1xuaW1wb3J0IG1hcFZhbHVlcyBmcm9tICdsb2Rhc2gvbWFwVmFsdWVzJ1xuXG5leHBvcnQgZGVmYXVsdCAobG9nZ2VyID0gKCkgPT4gY29uc29sZS5sb2cpID0+IHtcbiAgY29uc3QgZGVidWcgPSBsb2dnZXIoJ3NlcnZpY2VzOnN0b3JhZ2U6ZHluYW1vREInLCAnZGVidWcnKVxuICBjb25zdCBlcnJvciA9IGxvZ2dlcignc2VydmljZXM6c3RvcmFnZTpkeW5hbW9EQicsICdlcnJvcicpXG5cbiAgaWYgKCFwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICFwcm9jZXNzLmVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVkgfHwgIXByb2Nlc3MuZW52LkFXU19BQ0NFU1NfS0VZX0lEKSB7XG4gICAgZXJyb3IoJ0FXU19SRUdJT04sIEFXU19TRUNSRVRfQUNDRVNTX0tFWSBhbmQgQVdTX0FDQ0VTU19LRVlfSUQgYXJlIHJlcXVpcmVkJylcbiAgfVxuICBjb25zdCBwYXJhbXMgPSB7cmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OfVxuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xuICAgICAgcGFyYW1zLmVuZHBvaW50ID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6ODAwMCdcbiAgfVxuICBjb25zdCBkYiA9IG5ldyBEeW5hbW9EQihwYXJhbXMpXG4gIGNvbnN0IHN0b3JhZ2UgPSB7fVxuICBjb25zdCBrZXlzID0gWyd0ZWFtcycsICdjaGFubmVscycsICd1c2VycycsICdyZXNwb25zZXMnXVxuICBrZXlzLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHtcbiAgICBjb25zdCBkeW5hbW9UYWJsZSA9IHR5cGUgPT09ICdyZXNwb25zZXMnID8gJ3Jlc3BvbnNlJyA6IHR5cGVcbiAgICBzdG9yYWdlW3R5cGVdID0gZ2V0U3RvcmFnZShkYiwgZHluYW1vVGFibGUpXG4gIH0pXG5cbiAgZnVuY3Rpb24gZ2V0U3RvcmFnZSAoZGIsIHRhYmxlKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGdldDogaGFzaCA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGRlYnVnKCdmZXRjaGluZyBkb2Mgd2l0aCBoYXNoOiAnLCBoYXNoLCAnIGZyb20gJywgdGFibGUpXG4gICAgICAgIGNvbnN0IGNiID0gKGVyciwgcmVzKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgZXJyb3IoZXJyKVxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpXG4gICAgICAgICAgfVxuICAgICAgICAgIGRlYnVnKCdSZXNwb25zZSByZWNlaXZlZDogJywgcmVzKVxuICAgICAgICAgIGNvbnN0IGl0ZW1zID0gcmVzLkl0ZW1zIHx8IFtdXG4gICAgICAgICAgaWYgKGl0ZW1zLmxlbmd0aCA9PT0gMCkgeyAvLyBubyByZXN1bHQgZm91bmRcbiAgICAgICAgICAgIHJlc29sdmUobnVsbClcbiAgICAgICAgICB9IGVsc2UgeyAvLyByZXN1bHQgZm91bmRcbiAgICAgICAgICAgIHJlc29sdmUobWFwVmFsdWVzKGl0ZW1zWzBdLCBjbGVhblJlcykpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0YWJsZSA9PT0gJ3Jlc3BvbnNlcycpIHtcbiAgICAgICAgICBkYi5nZXRJdGVtKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogdGFibGUsXG4gICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgaW50ZW50TmFtZToge1xuICAgICAgICAgICAgICAgIFM6IGhhc2hcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sIGNiKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRiLmdldEl0ZW0oe1xuICAgICAgICAgICAgVGFibGVOYW1lOiB0YWJsZSxcbiAgICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgICBfaWQ6IHtcbiAgICAgICAgICAgICAgICBTOiBoYXNoXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LCBjYilcbiAgICAgICAgfVxuICAgICAgfSksXG5cbiAgICAgIHNhdmU6IGRhdGEgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBkZWJ1Zygnc2F2aW5nIGRvYyB3aXRoIGRhdGE6ICcsIGRhdGEpXG4gICAgICAgIGRiLnB1dEl0ZW0oe1xuICAgICAgICAgIFRhYmxlTmFtZTogdGFibGUsXG4gICAgICAgICAgSXRlbTogbWFwVmFsdWVzKGRhdGEsIHZhbHVlID0+ICh7XG4gICAgICAgICAgICBTOiB2YWx1ZVxuICAgICAgICAgIH0pKVxuICAgICAgICB9LCAoZXJyLCByZXMpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBlcnJvcihlcnIpXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycilcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzID0gcmVzIHx8IHt9XG4gICAgICAgICAgcmVzb2x2ZShyZXMpXG4gICAgICAgIH0pXG4gICAgICB9KSxcblxuICAgICAgYWxsOiAoKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGRlYnVnKCdmZXRjaGluZyBhbGwgZG9jcycpXG4gICAgICAgIGRiLnNjYW4oe1xuICAgICAgICAgIFRhYmxlTmFtZTogdGFibGVcbiAgICAgICAgfSwgKGVyciwgcmVzKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgZXJyb3IoZXJyKVxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpXG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IGl0ZW1zID0gcmVzLkl0ZW1zIHx8IFtdXG4gICAgICAgICAgcmVzb2x2ZShtYXBWYWx1ZXMoaXRlbXMsIGNsZWFuUmVzKSlcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gY2xlYW5SZXMgKHZhbHVlKSB7XG4gICAgcmV0dXJuIE9iamVjdC52YWx1ZXModmFsdWUpWzBdXG4gIH1cblxuICByZXR1cm4gc3RvcmFnZVxufVxuIl19