"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;var _awsSdk = _interopRequireDefault(require("aws-sdk"));
var _v = _interopRequireDefault(require("uuid/v4"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}function _defineProperty(obj, key, value) {if (key in obj) {Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true });} else {obj[key] = value;}return obj;}var
DynamoDB = _awsSdk["default"].DynamoDB;

var parse = DynamoDB.Converter.unmarshall;

var defaultModels = {
  teams: {
    hash: '_id' },

  channels: {
    hash: '_id' },

  users: {
    hash: '_id' } };var _default =



function _default() {var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var logger = config.logger ? config.logger : function () {return console.log;};
  var models = Object.assign(defaultModels, config.models);
  var debug = logger('services:storage:dynamoDB', 'debug');
  var error = logger('services:storage:dynamoDB', 'error');

  if (!process.env.AWS_REGION || !process.env.AWS_SECRET_ACCESS_KEY || !process.env.AWS_ACCESS_KEY_ID) {
    error('AWS_REGION, AWS_SECRET_ACCESS_KEY and AWS_ACCESS_KEY_ID are required');
  }
  var params = { region: process.env.AWS_REGION };
  if (process.env.NODE_ENV !== 'production') {
    params.endpoint = 'http://localhost:8000';
  }
  _awsSdk["default"].config.update(params);
  var db = new DynamoDB(params);
  var docClient = new DynamoDB.DocumentClient();
  var storage = {};
  var keys = Object.keys(models);
  keys.forEach(function (type) {
    var dynamoTable = process.env.RESOURCE_PREFIX + type;
    storage[type] = getStorage(db, dynamoTable);
  });

  function getStorage(db, table) {
    return {
      get: function get(hash, secondary) {return new Promise(function (resolve, reject) {
          var model = models[table.replace(process.env.RESOURCE_PREFIX, '')];
          var hashKey = model.hash;
          var secondaryKey = model.secondary;
          debug("fetching doc with ".concat(hashKey, " of ").concat(hash, " from  ").concat(table));
          var query = {};
          if (hashKey && hash) query[hashKey] = _defineProperty({}, hashKey === 'date' ? 'N' : 'S', String(hash));
          if (secondaryKey && secondary) query[secondaryKey] = _defineProperty({}, secondaryKey === 'date' ? 'N' : 'S', String(secondary));

          var cb = function cb(err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            var item = res.Item ? parse(res.Item) : null;
            debug('Response received: ', item);
            if (!item) {// no result found
              resolve(null);
            } else {// result found
              resolve(item);
            }
          };
          db.getItem({
            TableName: table,
            Key: query },
          cb);
        });},

      save: function save(data) {return new Promise(function (resolve, reject) {
          debug('saving doc with data: ', data);
          var hashKey = models[table.replace(process.env.RESOURCE_PREFIX, '')].hash;
          if (hashKey === '_id' && !data._id) {
            data._id = (0, _v["default"])();
          }
          docClient.put({
            TableName: table,
            Item: data },
          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            res = res || {};
            resolve(res);
          });
        });},

      all: function all(query) {return new Promise(function (resolve, reject) {
          var params = {
            TableName: table };

          if (query) {
            params.ExpressionAttributeValues = {
              ':a': {
                S: query.value } };


            params.FilterExpression = "#".concat(query.key.charAt(0)).concat(query.attributes.indexOf(query.key) > -1 ? query.attributes.indexOf(query.key) : '', " = :a");
            params.ExpressionAttributeNames = {};
            params.ProjectionExpression = query.attributes.map(function (attribute, i) {return "#".concat(attribute.charAt(0)).concat(i);}).join(', ');
            if (!query.attributes.includes(query.key)) {
              params.ExpressionAttributeNames["#".concat(query.key.charAt(0))] = query.key;
            }
            query.attributes.forEach(function (attribute, i) {
              params.ExpressionAttributeNames["#".concat(attribute.charAt(0)).concat(i)] = attribute;
            });
          }
          debug("fetching all docs from ".concat(table));
          db.scan(params, function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            var items = res.Items.map(parse) || [];
            debug('docs received: ', items);
            resolve(items);
          });
        });} };

  }

  return storage;
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbIkR5bmFtb0RCIiwiQVdTIiwicGFyc2UiLCJDb252ZXJ0ZXIiLCJ1bm1hcnNoYWxsIiwiZGVmYXVsdE1vZGVscyIsInRlYW1zIiwiaGFzaCIsImNoYW5uZWxzIiwidXNlcnMiLCJjb25maWciLCJsb2dnZXIiLCJjb25zb2xlIiwibG9nIiwibW9kZWxzIiwiT2JqZWN0IiwiYXNzaWduIiwiZGVidWciLCJlcnJvciIsInByb2Nlc3MiLCJlbnYiLCJBV1NfUkVHSU9OIiwiQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZIiwiQVdTX0FDQ0VTU19LRVlfSUQiLCJwYXJhbXMiLCJyZWdpb24iLCJOT0RFX0VOViIsImVuZHBvaW50IiwidXBkYXRlIiwiZGIiLCJkb2NDbGllbnQiLCJEb2N1bWVudENsaWVudCIsInN0b3JhZ2UiLCJrZXlzIiwiZm9yRWFjaCIsInR5cGUiLCJkeW5hbW9UYWJsZSIsIlJFU09VUkNFX1BSRUZJWCIsImdldFN0b3JhZ2UiLCJ0YWJsZSIsImdldCIsInNlY29uZGFyeSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwibW9kZWwiLCJyZXBsYWNlIiwiaGFzaEtleSIsInNlY29uZGFyeUtleSIsInF1ZXJ5IiwiU3RyaW5nIiwiY2IiLCJlcnIiLCJyZXMiLCJpdGVtIiwiSXRlbSIsImdldEl0ZW0iLCJUYWJsZU5hbWUiLCJLZXkiLCJzYXZlIiwiZGF0YSIsIl9pZCIsInB1dCIsImFsbCIsIkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMiLCJTIiwidmFsdWUiLCJGaWx0ZXJFeHByZXNzaW9uIiwia2V5IiwiY2hhckF0IiwiYXR0cmlidXRlcyIsImluZGV4T2YiLCJFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMiLCJQcm9qZWN0aW9uRXhwcmVzc2lvbiIsIm1hcCIsImF0dHJpYnV0ZSIsImkiLCJqb2luIiwiaW5jbHVkZXMiLCJzY2FuIiwiaXRlbXMiLCJJdGVtcyJdLCJtYXBwaW5ncyI6InVHQUFBO0FBQ0Es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QUEsS0FBSyxrQ0FBMkJzQixLQUEzQixFQUFMO0FBQ0FWLFVBQUFBLEVBQUUsQ0FBQ2tELElBQUgsQ0FBUXZELE1BQVIsRUFBZ0IsVUFBQzRCLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQzVCLGdCQUFJRCxHQUFKLEVBQVM7QUFDUGxDLGNBQUFBLEtBQUssQ0FBQ2tDLEdBQUQsQ0FBTDtBQUNBLHFCQUFPUixNQUFNLENBQUNRLEdBQUQsQ0FBYjtBQUNEO0FBQ0QsZ0JBQU00QixLQUFLLEdBQUczQixHQUFHLENBQUM0QixLQUFKLENBQVVQLEdBQVYsQ0FBY3hFLEtBQWQsS0FBd0IsRUFBdEM7QUFDQWUsWUFBQUEsS0FBSyxDQUFDLGlCQUFELEVBQW9CK0QsS0FBcEIsQ0FBTDtBQUNBckMsWUFBQUEsT0FBTyxDQUFDcUMsS0FBRCxDQUFQO0FBQ0QsV0FSRDtBQVNELFNBOUJlLENBQVgsRUFoREEsRUFBUDs7QUFnRkQ7O0FBRUQsU0FBT2hELE9BQVA7QUFDRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEFXUyBmcm9tICdhd3Mtc2RrJ1xuaW1wb3J0IHV1aWQgZnJvbSAndXVpZC92NCdcbmNvbnN0IHsgRHluYW1vREIgfSA9IEFXU1xuXG5jb25zdCBwYXJzZSA9IER5bmFtb0RCLkNvbnZlcnRlci51bm1hcnNoYWxsXG5cbmNvbnN0IGRlZmF1bHRNb2RlbHMgPSB7XG4gIHRlYW1zOiB7XG4gICAgaGFzaDogJ19pZCdcbiAgfSxcbiAgY2hhbm5lbHM6IHtcbiAgICBoYXNoOiAnX2lkJ1xuICB9LFxuICB1c2Vyczoge1xuICAgIGhhc2g6ICdfaWQnXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgKGNvbmZpZyA9IHt9KSA9PiB7XG4gIGNvbnN0IGxvZ2dlciA9IGNvbmZpZy5sb2dnZXIgPyBjb25maWcubG9nZ2VyIDogKCkgPT4gY29uc29sZS5sb2dcbiAgY29uc3QgbW9kZWxzID0gT2JqZWN0LmFzc2lnbihkZWZhdWx0TW9kZWxzLCBjb25maWcubW9kZWxzKVxuICBjb25zdCBkZWJ1ZyA9IGxvZ2dlcignc2VydmljZXM6c3RvcmFnZTpkeW5hbW9EQicsICdkZWJ1ZycpXG4gIGNvbnN0IGVycm9yID0gbG9nZ2VyKCdzZXJ2aWNlczpzdG9yYWdlOmR5bmFtb0RCJywgJ2Vycm9yJylcblxuICBpZiAoIXByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgIXByb2Nlc3MuZW52LkFXU19TRUNSRVRfQUNDRVNTX0tFWSB8fCAhcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQpIHtcbiAgICBlcnJvcignQVdTX1JFR0lPTiwgQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZIGFuZCBBV1NfQUNDRVNTX0tFWV9JRCBhcmUgcmVxdWlyZWQnKVxuICB9XG4gIGNvbnN0IHBhcmFtcyA9IHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIH1cbiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHtcbiAgICBwYXJhbXMuZW5kcG9pbnQgPSAnaHR0cDovL2xvY2FsaG9zdDo4MDAwJ1xuICB9XG4gIEFXUy5jb25maWcudXBkYXRlKHBhcmFtcylcbiAgY29uc3QgZGIgPSBuZXcgRHluYW1vREIocGFyYW1zKVxuICBjb25zdCBkb2NDbGllbnQgPSBuZXcgRHluYW1vREIuRG9jdW1lbnRDbGllbnQoKVxuICBjb25zdCBzdG9yYWdlID0ge31cbiAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG1vZGVscylcbiAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpIHtcbiAgICBjb25zdCBkeW5hbW9UYWJsZSA9IHByb2Nlc3MuZW52LlJFU09VUkNFX1BSRUZJWCArIHR5cGVcbiAgICBzdG9yYWdlW3R5cGVdID0gZ2V0U3RvcmFnZShkYiwgZHluYW1vVGFibGUpXG4gIH0pXG5cbiAgZnVuY3Rpb24gZ2V0U3RvcmFnZShkYiwgdGFibGUpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZ2V0OiAoaGFzaCwgc2Vjb25kYXJ5KSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IG1vZGVsID0gbW9kZWxzW3RhYmxlLnJlcGxhY2UocHJvY2Vzcy5lbnYuUkVTT1VSQ0VfUFJFRklYLCAnJyldXG4gICAgICAgIGNvbnN0IGhhc2hLZXkgPSBtb2RlbC5oYXNoXG4gICAgICAgIGNvbnN0IHNlY29uZGFyeUtleSA9IG1vZGVsLnNlY29uZGFyeVxuICAgICAgICBkZWJ1ZyhgZmV0Y2hpbmcgZG9jIHdpdGggJHtoYXNoS2V5fSBvZiAke2hhc2h9IGZyb20gICR7dGFibGV9YClcbiAgICAgICAgY29uc3QgcXVlcnkgPSB7fVxuICAgICAgICBpZiAoaGFzaEtleSAmJiBoYXNoKSBxdWVyeVtoYXNoS2V5XSA9IHsgW2hhc2hLZXkgPT09ICdkYXRlJyA/ICdOJyA6ICdTJ106IFN0cmluZyhoYXNoKSB9XG4gICAgICAgIGlmIChzZWNvbmRhcnlLZXkgJiYgc2Vjb25kYXJ5KSBxdWVyeVtzZWNvbmRhcnlLZXldID0geyBbc2Vjb25kYXJ5S2V5ID09PSAnZGF0ZScgPyAnTicgOiAnUyddOiBTdHJpbmcoc2Vjb25kYXJ5KSB9XG5cbiAgICAgICAgY29uc3QgY2IgPSAoZXJyLCByZXMpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBlcnJvcihlcnIpXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycilcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgaXRlbSA9IHJlcy5JdGVtID8gcGFyc2UocmVzLkl0ZW0pIDogbnVsbFxuICAgICAgICAgIGRlYnVnKCdSZXNwb25zZSByZWNlaXZlZDogJywgaXRlbSlcbiAgICAgICAgICBpZiAoIWl0ZW0pIHsgLy8gbm8gcmVzdWx0IGZvdW5kXG4gICAgICAgICAgICByZXNvbHZlKG51bGwpXG4gICAgICAgICAgfSBlbHNlIHsgLy8gcmVzdWx0IGZvdW5kXG4gICAgICAgICAgICByZXNvbHZlKGl0ZW0pXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGRiLmdldEl0ZW0oe1xuICAgICAgICAgIFRhYmxlTmFtZTogdGFibGUsXG4gICAgICAgICAgS2V5OiBxdWVyeVxuICAgICAgICB9LCBjYilcbiAgICAgIH0pLFxuXG4gICAgICBzYXZlOiBkYXRhID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgZGVidWcoJ3NhdmluZyBkb2Mgd2l0aCBkYXRhOiAnLCBkYXRhKVxuICAgICAgICBjb25zdCBoYXNoS2V5ID0gbW9kZWxzW3RhYmxlLnJlcGxhY2UocHJvY2Vzcy5lbnYuUkVTT1VSQ0VfUFJFRklYLCAnJyldLmhhc2hcbiAgICAgICAgaWYgKGhhc2hLZXkgPT09ICdfaWQnICYmICFkYXRhLl9pZCkge1xuICAgICAgICAgIGRhdGEuX2lkID0gdXVpZCgpXG4gICAgICAgIH1cbiAgICAgICAgZG9jQ2xpZW50LnB1dCh7XG4gICAgICAgICAgVGFibGVOYW1lOiB0YWJsZSxcbiAgICAgICAgICBJdGVtOiBkYXRhXG4gICAgICAgIH0sIChlcnIsIHJlcykgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGVycm9yKGVycilcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXMgPSByZXMgfHwge31cbiAgICAgICAgICByZXNvbHZlKHJlcylcbiAgICAgICAgfSlcbiAgICAgIH0pLFxuXG4gICAgICBhbGw6IChxdWVyeSkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICAgICAgVGFibGVOYW1lOiB0YWJsZVxuICAgICAgICB9XG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzID0ge1xuICAgICAgICAgICAgJzphJzoge1xuICAgICAgICAgICAgICBTOiBxdWVyeS52YWx1ZVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBwYXJhbXMuRmlsdGVyRXhwcmVzc2lvbiA9IGAjJHtxdWVyeS5rZXkuY2hhckF0KDApfSR7cXVlcnkuYXR0cmlidXRlcy5pbmRleE9mKHF1ZXJ5LmtleSkgPiAtMSA/IHF1ZXJ5LmF0dHJpYnV0ZXMuaW5kZXhPZihxdWVyeS5rZXkpIDogJyd9ID0gOmFgXG4gICAgICAgICAgcGFyYW1zLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyA9IHt9XG4gICAgICAgICAgcGFyYW1zLlByb2plY3Rpb25FeHByZXNzaW9uID0gcXVlcnkuYXR0cmlidXRlcy5tYXAoKGF0dHJpYnV0ZSwgaSkgPT4gYCMke2F0dHJpYnV0ZS5jaGFyQXQoMCl9JHtpfWApLmpvaW4oJywgJylcbiAgICAgICAgICBpZiAoIXF1ZXJ5LmF0dHJpYnV0ZXMuaW5jbHVkZXMocXVlcnkua2V5KSkge1xuICAgICAgICAgICAgcGFyYW1zLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1tgIyR7cXVlcnkua2V5LmNoYXJBdCgwKX1gXSA9IHF1ZXJ5LmtleVxuICAgICAgICAgIH1cbiAgICAgICAgICBxdWVyeS5hdHRyaWJ1dGVzLmZvckVhY2goKGF0dHJpYnV0ZSwgaSkgPT4ge1xuICAgICAgICAgICAgcGFyYW1zLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1tgIyR7YXR0cmlidXRlLmNoYXJBdCgwKX0ke2l9YF0gPSBhdHRyaWJ1dGVcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICAgIGRlYnVnKGBmZXRjaGluZyBhbGwgZG9jcyBmcm9tICR7dGFibGV9YClcbiAgICAgICAgZGIuc2NhbihwYXJhbXMsIChlcnIsIHJlcykgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGVycm9yKGVycilcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBpdGVtcyA9IHJlcy5JdGVtcy5tYXAocGFyc2UpIHx8IFtdXG4gICAgICAgICAgZGVidWcoJ2RvY3MgcmVjZWl2ZWQ6ICcsIGl0ZW1zKVxuICAgICAgICAgIHJlc29sdmUoaXRlbXMpXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBzdG9yYWdlXG59XG4iXX0=