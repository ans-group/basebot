"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;
var _awsSdk = require("aws-sdk");
var _mapValues = _interopRequireDefault(require("lodash/mapValues"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };} // based on https://github.com/joshuahoover/botkit-storage-dynamodb/blob/master/src/index.js
var _default =
function _default() {var logger = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : function () {return console.log;};
  var debug = logger('services:storage:dynamoDB', 'debug');
  var error = logger('services:storage:dynamoDB', 'error');

  if (!process.env.AWS_REGION || !process.env.AWS_SECRET_ACCESS_KEY || !process.env.AWS_ACCESS_KEY_ID) {
    error('AWS_REGION, AWS_SECRET_ACCESS_KEY and AWS_ACCESS_KEY_ID are required');
  }

  var db = new _awsSdk.DynamoDB({ region: process.env.AWS_REGION });
  var storage = {};
  var keys = ['teams', 'channels', 'users', 'responses'];
  keys.forEach(function (type) {
    var dynamoTable = type;
    storage[type] = getStorage(db, dynamoTable);
  });

  function getStorage(db, table) {
    return {
      get: function get(hash) {return new Promise(function (resolve, reject) {
          debug('fetching doc with hash: ', hash, ' from ', table);
          var cb = function cb(err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            debug('Response received: ', res);
            var items = res.Items || [];
            if (items.length === 0) {// no result found
              resolve(null);
            } else {// result found
              resolve((0, _mapValues["default"])(items[0], cleanRes));
            }
          };
          if (table === 'responses') {
            db.query({
              TableName: table,
              IndexName: 'intentName',
              KeyConditionExpression: 'intentName = :v1',
              ExpressionAttributeValues: {
                ':v1': {
                  S: hash } } },


            cb);
          } else {
            db.getItem({
              TableName: table,
              Key: {
                _id: {
                  S: hash } } },


            cb);
          }
        });},

      save: function save(data) {return new Promise(function (resolve, reject) {
          debug('saving doc with data: ', data);
          db.putItem({
            TableName: table,
            Item: (0, _mapValues["default"])(data, function (value) {return {
                S: value };}) },

          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            res = res || {};
            resolve(res);
          });
        });},

      all: function all() {return new Promise(function (resolve, reject) {
          debug('fetching all docs');
          db.scan({
            TableName: table },
          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            var items = res.Items || [];
            resolve((0, _mapValues["default"])(items, cleanRes));
          });
        });} };

  }

  function cleanRes(value) {
    return Object.values(value)[0];
  }

  return storage;
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImNvbnNvbGUiLCJsb2ciLCJkZWJ1ZyIsImVycm9yIiwicHJvY2VzcyIsImVudiIsIkFXU19SRUdJT04iLCJBV1NfU0VDUkVUX0FDQ0VTU19LRVkiLCJBV1NfQUNDRVNTX0tFWV9JRCIsImRiIiwiRHluYW1vREIiLCJyZWdpb24iLCJzdG9yYWdlIiwia2V5cyIsImZvckVhY2giLCJ0eXBlIiwiZHluYW1vVGFibGUiLCJnZXRTdG9yYWdlIiwidGFibGUiLCJnZXQiLCJoYXNoIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJjYiIsImVyciIsInJlcyIsIml0ZW1zIiwiSXRlbXMiLCJsZW5ndGgiLCJjbGVhblJlcyIsInF1ZXJ5IiwiVGFibGVOYW1lIiwiSW5kZXhOYW1lIiwiS2V5Q29uZGl0aW9uRXhwcmVzc2lvbiIsIkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMiLCJTIiwiZ2V0SXRlbSIsIktleSIsIl9pZCIsInNhdmUiLCJkYXRhIiwicHV0SXRlbSIsIkl0ZW0iLCJ2YWx1ZSIsImFsbCIsInNjYW4iLCJPYmplY3QiLCJ2YWx1ZXMiXSwibWFwcGluZ3MiOiI7QUFDQTtBQUNBLHFFLGdHQUZBOztBQUllLG9CQUFnQyxLQUEvQkEsTUFBK0IsdUVBQXRCLG9CQUFNQyxPQUFPLENBQUNDLEdBQWQsRUFBc0I7QUFDN0MsTUFBTUMsS0FBSyxHQUFHSCxNQUFNLENBQUMsMkJBQUQsRUFBOEIsT0FBOUIsQ0FBcEI7QUFDQSxNQUFNSSxLQUFLLEdBQUdKLE1BQU0sQ0FBQywyQkFBRCxFQUE4QixPQUE5QixDQUFwQjs7QUFFQSxNQUFJLENBQUNLLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxVQUFiLElBQTJCLENBQUNGLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRSxxQkFBeEMsSUFBaUUsQ0FBQ0gsT0FBTyxDQUFDQyxHQUFSLENBQVlHLGlCQUFsRixFQUFxRztBQUNuR0wsSUFBQUEsS0FBSyxDQUFDLHNFQUFE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QUFLRyxvQkFBQ25CLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ2YsZ0JBQUlELEdBQUosRUFBUztBQUNQdEIsY0FBQUEsS0FBSyxDQUFDc0IsR0FBRCxDQUFMO0FBQ0EscUJBQU9GLE1BQU0sQ0FBQ0UsR0FBRCxDQUFiO0FBQ0Q7QUFDREMsWUFBQUEsR0FBRyxHQUFHQSxHQUFHLElBQUksRUFBYjtBQUNBSixZQUFBQSxPQUFPLENBQUNJLEdBQUQsQ0FBUDtBQUNELFdBWkQ7QUFhRCxTQWZhLENBQUosRUF2Q0w7O0FBd0RMbUIsTUFBQUEsR0FBRyxFQUFFLHVCQUFNLElBQUl4QixPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQzFDckIsVUFBQUEsS0FBSyxDQUFDLG1CQUFELENBQUw7QUFDQU8sVUFBQUEsRUFBRSxDQUFDcUMsSUFBSCxDQUFRO0FBQ05kLFlBQUFBLFNBQVMsRUFBRWQsS0FETCxFQUFSO0FBRUcsb0JBQUNPLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ2YsZ0JBQUlELEdBQUosRUFBUztBQUNQdEIsY0FBQUEsS0FBSyxDQUFDc0IsR0FBRCxDQUFMO0FBQ0EscUJBQU9GLE1BQU0sQ0FBQ0UsR0FBRCxDQUFiO0FBQ0Q7QUFDRCxnQkFBTUUsS0FBSyxHQUFHRCxHQUFHLENBQUNFLEtBQUosSUFBYSxFQUEzQjtBQUNBTixZQUFBQSxPQUFPLENBQUMsMkJBQVVLLEtBQVYsRUFBaUJHLFFBQWpCLENBQUQsQ0FBUDtBQUNELFdBVEQ7QUFVRCxTQVpVLENBQU4sRUF4REEsRUFBUDs7QUFzRUQ7O0FBRUQsV0FBU0EsUUFBVCxDQUFtQmMsS0FBbkIsRUFBMEI7QUFDeEIsV0FBT0csTUFBTSxDQUFDQyxNQUFQLENBQWNKLEtBQWQsRUFBcUIsQ0FBckIsQ0FBUDtBQUNEOztBQUVELFNBQU9oQyxPQUFQO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGJhc2VkIG9uIGh0dHBzOi8vZ2l0aHViLmNvbS9qb3NodWFob292ZXIvYm90a2l0LXN0b3JhZ2UtZHluYW1vZGIvYmxvYi9tYXN0ZXIvc3JjL2luZGV4LmpzXG5pbXBvcnQgeyBEeW5hbW9EQiB9IGZyb20gJ2F3cy1zZGsnXG5pbXBvcnQgbWFwVmFsdWVzIGZyb20gJ2xvZGFzaC9tYXBWYWx1ZXMnXG5cbmV4cG9ydCBkZWZhdWx0IChsb2dnZXIgPSAoKSA9PiBjb25zb2xlLmxvZykgPT4ge1xuICBjb25zdCBkZWJ1ZyA9IGxvZ2dlcignc2VydmljZXM6c3RvcmFnZTpkeW5hbW9EQicsICdkZWJ1ZycpXG4gIGNvbnN0IGVycm9yID0gbG9nZ2VyKCdzZXJ2aWNlczpzdG9yYWdlOmR5bmFtb0RCJywgJ2Vycm9yJylcblxuICBpZiAoIXByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgIXByb2Nlc3MuZW52LkFXU19TRUNSRVRfQUNDRVNTX0tFWSB8fCAhcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQpIHtcbiAgICBlcnJvcignQVdTX1JFR0lPTiwgQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZIGFuZCBBV1NfQUNDRVNTX0tFWV9JRCBhcmUgcmVxdWlyZWQnKVxuICB9XG5cbiAgY29uc3QgZGIgPSBuZXcgRHluYW1vREIoe3JlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTn0pXG4gIGNvbnN0IHN0b3JhZ2UgPSB7fVxuICBjb25zdCBrZXlzID0gWyd0ZWFtcycsICdjaGFubmVscycsICd1c2VycycsICdyZXNwb25zZXMnXVxuICBrZXlzLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHtcbiAgICBjb25zdCBkeW5hbW9UYWJsZSA9IHR5cGVcbiAgICBzdG9yYWdlW3R5cGVdID0gZ2V0U3RvcmFnZShkYiwgZHluYW1vVGFibGUpXG4gIH0pXG5cbiAgZnVuY3Rpb24gZ2V0U3RvcmFnZSAoZGIsIHRhYmxlKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGdldDogaGFzaCA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGRlYnVnKCdmZXRjaGluZyBkb2Mgd2l0aCBoYXNoOiAnLCBoYXNoLCAnIGZyb20gJywgdGFibGUpXG4gICAgICAgIGNvbnN0IGNiID0gKGVyciwgcmVzKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgZXJyb3IoZXJyKVxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpXG4gICAgICAgICAgfVxuICAgICAgICAgIGRlYnVnKCdSZXNwb25zZSByZWNlaXZlZDogJywgcmVzKVxuICAgICAgICAgIGNvbnN0IGl0ZW1zID0gcmVzLkl0ZW1zIHx8IFtdXG4gICAgICAgICAgaWYgKGl0ZW1zLmxlbmd0aCA9PT0gMCkgeyAvLyBubyByZXN1bHQgZm91bmRcbiAgICAgICAgICAgIHJlc29sdmUobnVsbClcbiAgICAgICAgICB9IGVsc2UgeyAvLyByZXN1bHQgZm91bmRcbiAgICAgICAgICAgIHJlc29sdmUobWFwVmFsdWVzKGl0ZW1zWzBdLCBjbGVhblJlcykpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0YWJsZSA9PT0gJ3Jlc3BvbnNlcycpIHtcbiAgICAgICAgICBkYi5xdWVyeSh7XG4gICAgICAgICAgICBUYWJsZU5hbWU6IHRhYmxlLFxuICAgICAgICAgICAgSW5kZXhOYW1lOiAnaW50ZW50TmFtZScsXG4gICAgICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnaW50ZW50TmFtZSA9IDp2MScsXG4gICAgICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAgICc6djEnOiB7XG4gICAgICAgICAgICAgICAgUzogaGFzaFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSwgY2IpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGIuZ2V0SXRlbSh7XG4gICAgICAgICAgICBUYWJsZU5hbWU6IHRhYmxlLFxuICAgICAgICAgICAgS2V5OiB7XG4gICAgICAgICAgICAgIF9pZDoge1xuICAgICAgICAgICAgICAgIFM6IGhhc2hcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sIGNiKVxuICAgICAgICB9XG4gICAgICB9KSxcblxuICAgICAgc2F2ZTogZGF0YSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGRlYnVnKCdzYXZpbmcgZG9jIHdpdGggZGF0YTogJywgZGF0YSlcbiAgICAgICAgZGIucHV0SXRlbSh7XG4gICAgICAgICAgVGFibGVOYW1lOiB0YWJsZSxcbiAgICAgICAgICBJdGVtOiBtYXBWYWx1ZXMoZGF0YSwgdmFsdWUgPT4gKHtcbiAgICAgICAgICAgIFM6IHZhbHVlXG4gICAgICAgICAgfSkpXG4gICAgICAgIH0sIChlcnIsIHJlcykgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGVycm9yKGVycilcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXMgPSByZXMgfHwge31cbiAgICAgICAgICByZXNvbHZlKHJlcylcbiAgICAgICAgfSlcbiAgICAgIH0pLFxuXG4gICAgICBhbGw6ICgpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgZGVidWcoJ2ZldGNoaW5nIGFsbCBkb2NzJylcbiAgICAgICAgZGIuc2Nhbih7XG4gICAgICAgICAgVGFibGVOYW1lOiB0YWJsZVxuICAgICAgICB9LCAoZXJyLCByZXMpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBlcnJvcihlcnIpXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycilcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgaXRlbXMgPSByZXMuSXRlbXMgfHwgW11cbiAgICAgICAgICByZXNvbHZlKG1hcFZhbHVlcyhpdGVtcywgY2xlYW5SZXMpKVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBjbGVhblJlcyAodmFsdWUpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh2YWx1ZSlbMF1cbiAgfVxuXG4gIHJldHVybiBzdG9yYWdlXG59XG4iXX0=