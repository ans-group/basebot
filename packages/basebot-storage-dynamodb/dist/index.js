"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;
var _awsSdk = require("aws-sdk");
var _mapValues = _interopRequireDefault(require("lodash/mapValues"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };} // based on https://github.com/joshuahoover/botkit-storage-dynamodb/blob/master/src/index.js
var _default =
function _default() {var logger = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : function () {return console.log;};
  if (!process.env.AWS_REGION || !process.env.AWS_SECRET_ACCESS_KEY || !process.env.AWS_ACCESS_KEY_ID) throw new Error('AWS_REGION, AWS_SECRET_ACCESS_KEY and AWS_ACCESS_KEY_ID are required');
  var debug = logger('services:storage:dynamoDB', 'debug');
  var error = logger('services:storage:dynamoDB', 'error');

  var db = new _awsSdk.DynamoDB({ region: process.env.AWS_REGION });
  var storage = {};
  var keys = ['teams', 'channels', 'users', 'responses'];
  keys.forEach(function (type) {
    var dynamoTable = type;
    storage[type] = getStorage(db, dynamoTable);
  });

  function getStorage(db, table) {
    return {
      get: function get(hash) {return new Promise(function (resolve, reject) {
          debug('fetching doc with hash: ', hash, ' from ', table);
          var cb = function cb(err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            debug('Response received: ', res);
            var items = res.Items || [];
            if (items.length === 0) {// no result found
              resolve(null);
            } else {// result found
              resolve((0, _mapValues["default"])(items[0], cleanRes));
            }
          };
          if (table === 'responses') {
            db.query({
              TableName: table,
              IndexName: 'intentName',
              KeyConditionExpression: 'intentName = :v1',
              ExpressionAttributeValues: {
                ':v1': {
                  S: hash } } },


            cb);
          } else {
            db.getItem({
              TableName: table,
              Key: {
                _id: {
                  S: hash } } },


            cb);
          }
        });},

      save: function save(data) {return new Promise(function (resolve, reject) {
          debug('saving doc with data: ', data);
          db.putItem({
            TableName: table,
            Item: (0, _mapValues["default"])(data, function (value) {return {
                S: value };}) },

          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            res = res || {};
            resolve(res);
          });
        });},

      all: function all() {return new Promise(function (resolve, reject) {
          debug('fetching all docs');
          db.scan({
            TableName: table },
          function (err, res) {
            if (err) {
              error(err);
              return reject(err);
            }
            var items = res.Items || [];
            resolve((0, _mapValues["default"])(items, cleanRes));
          });
        });} };

  }

  function cleanRes(value) {
    return Object.values(value)[0];
  }

  return storage;
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImNvbnNvbGUiLCJsb2ciLCJwcm9jZXNzIiwiZW52IiwiQVdTX1JFR0lPTiIsIkFXU19TRUNSRVRfQUNDRVNTX0tFWSIsIkFXU19BQ0NFU1NfS0VZX0lEIiwiRXJyb3IiLCJkZWJ1ZyIsImVycm9yIiwiZGIiLCJEeW5hbW9EQiIsInJlZ2lvbiIsInN0b3JhZ2UiLCJrZXlzIiwiZm9yRWFjaCIsInR5cGUiLCJkeW5hbW9UYWJsZSIsImdldFN0b3JhZ2UiLCJ0YWJsZSIsImdldCIsImhhc2giLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImNiIiwiZXJyIiwicmVzIiwiaXRlbXMiLCJJdGVtcyIsImxlbmd0aCIsImNsZWFuUmVzIiwicXVlcnkiLCJUYWJsZU5hbWUiLCJJbmRleE5hbWUiLCJLZXlDb25kaXRpb25FeHByZXNzaW9uIiwiRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyIsIlMiLCJnZXRJdGVtIiwiS2V5IiwiX2lkIiwic2F2ZSIsImRhdGEiLCJwdXRJdGVtIiwiSXRlbSIsInZhbHVlIiwiYWxsIiwic2NhbiIsIk9iamVjdCIsInZhbHVlcyJdLCJtYXBwaW5ncyI6IjtBQUNBO0FBQ0EscUUsZ0dBRkE7O0FBSWUsb0JBQWdDLEtBQS9CQSxNQUErQix1RUFBdEIsb0JBQU1DLE9BQU8sQ0FBQ0MsR0FBZCxFQUFzQjtBQUM3QyxNQUFJLENBQUNDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxVQUFiLElBQTJCLENBQUNGLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRSxxQkFBeEMsSUFBaUUsQ0FBQ0gsT0FBTyxDQUFDQyxHQUFSLENBQVlHLGlCQUFsRixFQUFxRyxNQUFNLElBQUlDLEtBQUosQ0FBVSxzRUFBVixDQUFOO0FBQ3JHLE1BQU1DLEtBQUssR0FBR1QsTUFBTSxDQUFDLDJCQUFELEVBQThCLE9BQTlCLENBQXBCO0FBQ0EsTUFBTVUsS0FBSyxHQUFHVixNQUFNLENBQUMsMkJBQUQsRUFBOEIs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QUFLRyxvQkFBQ25CLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ2YsZ0JBQUlELEdBQUosRUFBUztBQUNQakIsY0FBQUEsS0FBSyxDQUFDaUIsR0FBRCxDQUFMO0FBQ0EscUJBQU9GLE1BQU0sQ0FBQ0UsR0FBRCxDQUFiO0FBQ0Q7QUFDREMsWUFBQUEsR0FBRyxHQUFHQSxHQUFHLElBQUksRUFBYjtBQUNBSixZQUFBQSxPQUFPLENBQUNJLEdBQUQsQ0FBUDtBQUNELFdBWkQ7QUFhRCxTQWZhLENBQUosRUF2Q0w7O0FBd0RMbUIsTUFBQUEsR0FBRyxFQUFFLHVCQUFNLElBQUl4QixPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQzFDaEIsVUFBQUEsS0FBSyxDQUFDLG1CQUFELENBQUw7QUFDQUUsVUFBQUEsRUFBRSxDQUFDcUMsSUFBSCxDQUFRO0FBQ05kLFlBQUFBLFNBQVMsRUFBRWQsS0FETCxFQUFSO0FBRUcsb0JBQUNPLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ2YsZ0JBQUlELEdBQUosRUFBUztBQUNQakIsY0FBQUEsS0FBSyxDQUFDaUIsR0FBRCxDQUFMO0FBQ0EscUJBQU9GLE1BQU0sQ0FBQ0UsR0FBRCxDQUFiO0FBQ0Q7QUFDRCxnQkFBTUUsS0FBSyxHQUFHRCxHQUFHLENBQUNFLEtBQUosSUFBYSxFQUEzQjtBQUNBTixZQUFBQSxPQUFPLENBQUMsMkJBQVVLLEtBQVYsRUFBaUJHLFFBQWpCLENBQUQsQ0FBUDtBQUNELFdBVEQ7QUFVRCxTQVpVLENBQU4sRUF4REEsRUFBUDs7QUFzRUQ7O0FBRUQsV0FBU0EsUUFBVCxDQUFtQmMsS0FBbkIsRUFBMEI7QUFDeEIsV0FBT0csTUFBTSxDQUFDQyxNQUFQLENBQWNKLEtBQWQsRUFBcUIsQ0FBckIsQ0FBUDtBQUNEOztBQUVELFNBQU9oQyxPQUFQO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGJhc2VkIG9uIGh0dHBzOi8vZ2l0aHViLmNvbS9qb3NodWFob292ZXIvYm90a2l0LXN0b3JhZ2UtZHluYW1vZGIvYmxvYi9tYXN0ZXIvc3JjL2luZGV4LmpzXG5pbXBvcnQgeyBEeW5hbW9EQiB9IGZyb20gJ2F3cy1zZGsnXG5pbXBvcnQgbWFwVmFsdWVzIGZyb20gJ2xvZGFzaC9tYXBWYWx1ZXMnXG5cbmV4cG9ydCBkZWZhdWx0IChsb2dnZXIgPSAoKSA9PiBjb25zb2xlLmxvZykgPT4ge1xuICBpZiAoIXByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgIXByb2Nlc3MuZW52LkFXU19TRUNSRVRfQUNDRVNTX0tFWSB8fCAhcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQpIHRocm93IG5ldyBFcnJvcignQVdTX1JFR0lPTiwgQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZIGFuZCBBV1NfQUNDRVNTX0tFWV9JRCBhcmUgcmVxdWlyZWQnKVxuICBjb25zdCBkZWJ1ZyA9IGxvZ2dlcignc2VydmljZXM6c3RvcmFnZTpkeW5hbW9EQicsICdkZWJ1ZycpXG4gIGNvbnN0IGVycm9yID0gbG9nZ2VyKCdzZXJ2aWNlczpzdG9yYWdlOmR5bmFtb0RCJywgJ2Vycm9yJylcblxuICBjb25zdCBkYiA9IG5ldyBEeW5hbW9EQih7cmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OfSlcbiAgY29uc3Qgc3RvcmFnZSA9IHt9XG4gIGNvbnN0IGtleXMgPSBbJ3RlYW1zJywgJ2NoYW5uZWxzJywgJ3VzZXJzJywgJ3Jlc3BvbnNlcyddXG4gIGtleXMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkge1xuICAgIGNvbnN0IGR5bmFtb1RhYmxlID0gdHlwZVxuICAgIHN0b3JhZ2VbdHlwZV0gPSBnZXRTdG9yYWdlKGRiLCBkeW5hbW9UYWJsZSlcbiAgfSlcblxuICBmdW5jdGlvbiBnZXRTdG9yYWdlIChkYiwgdGFibGUpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZ2V0OiBoYXNoID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgZGVidWcoJ2ZldGNoaW5nIGRvYyB3aXRoIGhhc2g6ICcsIGhhc2gsICcgZnJvbSAnLCB0YWJsZSlcbiAgICAgICAgY29uc3QgY2IgPSAoZXJyLCByZXMpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBlcnJvcihlcnIpXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycilcbiAgICAgICAgICB9XG4gICAgICAgICAgZGVidWcoJ1Jlc3BvbnNlIHJlY2VpdmVkOiAnLCByZXMpXG4gICAgICAgICAgY29uc3QgaXRlbXMgPSByZXMuSXRlbXMgfHwgW11cbiAgICAgICAgICBpZiAoaXRlbXMubGVuZ3RoID09PSAwKSB7IC8vIG5vIHJlc3VsdCBmb3VuZFxuICAgICAgICAgICAgcmVzb2x2ZShudWxsKVxuICAgICAgICAgIH0gZWxzZSB7IC8vIHJlc3VsdCBmb3VuZFxuICAgICAgICAgICAgcmVzb2x2ZShtYXBWYWx1ZXMoaXRlbXNbMF0sIGNsZWFuUmVzKSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRhYmxlID09PSAncmVzcG9uc2VzJykge1xuICAgICAgICAgIGRiLnF1ZXJ5KHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogdGFibGUsXG4gICAgICAgICAgICBJbmRleE5hbWU6ICdpbnRlbnROYW1lJyxcbiAgICAgICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdpbnRlbnROYW1lID0gOnYxJyxcbiAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAgICAgJzp2MSc6IHtcbiAgICAgICAgICAgICAgICBTOiBoYXNoXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LCBjYilcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkYi5nZXRJdGVtKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogdGFibGUsXG4gICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgX2lkOiB7XG4gICAgICAgICAgICAgICAgUzogaGFzaFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSwgY2IpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuXG4gICAgICBzYXZlOiBkYXRhID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgZGVidWcoJ3NhdmluZyBkb2Mgd2l0aCBkYXRhOiAnLCBkYXRhKVxuICAgICAgICBkYi5wdXRJdGVtKHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHRhYmxlLFxuICAgICAgICAgIEl0ZW06IG1hcFZhbHVlcyhkYXRhLCB2YWx1ZSA9PiAoe1xuICAgICAgICAgICAgUzogdmFsdWVcbiAgICAgICAgICB9KSlcbiAgICAgICAgfSwgKGVyciwgcmVzKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgZXJyb3IoZXJyKVxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpXG4gICAgICAgICAgfVxuICAgICAgICAgIHJlcyA9IHJlcyB8fCB7fVxuICAgICAgICAgIHJlc29sdmUocmVzKVxuICAgICAgICB9KVxuICAgICAgfSksXG5cbiAgICAgIGFsbDogKCkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBkZWJ1ZygnZmV0Y2hpbmcgYWxsIGRvY3MnKVxuICAgICAgICBkYi5zY2FuKHtcbiAgICAgICAgICBUYWJsZU5hbWU6IHRhYmxlXG4gICAgICAgIH0sIChlcnIsIHJlcykgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGVycm9yKGVycilcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBpdGVtcyA9IHJlcy5JdGVtcyB8fCBbXVxuICAgICAgICAgIHJlc29sdmUobWFwVmFsdWVzKGl0ZW1zLCBjbGVhblJlcykpXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGNsZWFuUmVzICh2YWx1ZSkge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHZhbHVlKVswXVxuICB9XG5cbiAgcmV0dXJuIHN0b3JhZ2Vcbn1cbiJdfQ==