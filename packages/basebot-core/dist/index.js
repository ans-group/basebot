"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.init = void 0;var _configParser = require("./configParser");
var _server = _interopRequireDefault(require("./server"));
var _applySkills = _interopRequireDefault(require("./applySkills"));
var _startChannels = _interopRequireDefault(require("./startChannels"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}

var init = function init(_ref) {var skills = _ref.skills,config = _ref.config;
  var logger = (0, _configParser.getSingleModule)(config.logger);
  var channels = (0, _configParser.getAllModules)(config.channels);
  var rawMiddleware = (0, _configParser.getAllModules)(config.middleware);
  var models = (0, _configParser.getAllModels)(rawMiddleware);
  var storage = (0, _configParser.getSingleModule)(config.storage)({ logger: logger, models: models });
  var middleware = rawMiddleware.map(function (mw) {return mw({ storage: storage, logger: logger });});
  var info = logger('core', 'info');var _Server =
  (0, _server["default"])({ logger: logger }),server = _Server.server,app = _Server.app;
  var controllers = (0, _startChannels["default"])({ channels: channels, storage: storage, logger: logger, server: server, app: app });
  // start server
  if (process.env.NODE_ENV !== 'test') {
    info('setting up server on port: ' + (process.env.PORT || 3000));
    app.listen(process.env.PORT || 3000);
  }

  (0, _applySkills["default"])({ channels: controllers, middleware: middleware, logger: logger, skills: skills });
  return {
    controllers: controllers,
    storage: storage,
    logger: logger };

};exports.init = init;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJpbml0Iiwic2tpbGxzIiwiY29uZmlnIiwibG9nZ2VyIiwiY2hhbm5lbHMiLCJyYXdNaWRkbGV3YXJlIiwibWlkZGxld2FyZSIsIm1vZGVscyIsInN0b3JhZ2UiLCJtYXAiLCJtdyIsImluZm8iLCJzZXJ2ZXIiLCJhcHAiLCJjb250cm9sbGVycyIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsIlBPUlQiLCJsaXN0ZW4iXSwibWFwcGluZ3MiOiJpR0FBQTtBQUNBO0FBQ0E7QUFDQSx3RTs7QUFFTyxJQUFNQSxJQUFJLEdBQUcsU0FBUEEsSUFBTyxPQUF3QixLQUFyQkMsTUFBcUIsUUFBckJBLE1BQXFCLENBQWJDLE1BQWEsUUFBYkEsTUFBYTtBQUMxQyxNQUFNQyxNQUFNLEdBQUcsbUNBQWdCRCxNQUFNLENBQUNDLE1BQXZCLENBQWY7QUFDQSxNQUFNQyxRQUFRLEdBQUcsaUNBQWNGLE1BQU0sQ0FBQ0UsUUFBckIsQ0FBakI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsaUNBQWNILE1BQU0sQ0FBQ0ksVUFBckIsQ0FBdEI7QUFDQSxNQUFNQyxNQUFNLEdBQUcsZ0NBQWFGLGFBQWIsQ0FBZjtBQUNBLE1BQU1HLE9BQU8sR0FBRyxtQ0FBZ0JOLE1BQU0sQ0FBQ00sT0FBdkIsRUFBZ0MsRUFBRUwsTUFBTSxFQUFOQSxNQUFGLEVBQVVJLE1BQU0sRUFBTkEsTUFBVixFQUFoQyxDQUFoQjtBQUNBLE1BQU1ELFVBQVUsR0FBR0QsYUFBYSxDQUFDSSxHQUFkLENBQWtCLFVBQUFDLEVBQUUsVUFBSUEsRUFBRSxDQUFDLEVBQUVGLE9BQU8sRUFBUEEsT0FBRixFQUFXTCxNQUFNLEVBQU5BLE1BQVgsRUFBRCxDQUFOLEVBQXBCLENBQW5CO0FBQ0EsTUFBTVEsSUFBSSxHQUFHUixNQUFNLENBQUMsTUFBRCxFQUFTLE1BQVQsQ0FBbkIsQ0FQMEM7QUFRbEIsMEJBQU8sRUFBRUEsTUFBTSxFQUFOQSxNQUFGLEVBQVAsQ0FSa0IsQ0FRbENTLE1BUmtDLFdBUWxDQSxNQVJrQyxDQVExQkMsR0FSMEIsV0FRMUJBLEdBUjBCO0FBUzFDLE1BQU1DLFdBQVcsR0FBRywrQkFBYyxFQUFFVixRQUFRLEVBQVJBLFFBQUYsRUFBWUksT0FBTyxFQUFQQSxPQUFaLEVBQXFCTCxNQUFNLEVBQU5BLE1BQXJCLEVBQTZCUyxNQUFNLEVBQU5BLE1BQTdCLEVBQXFDQyxHQUFHLEVBQUhBLEdBQXJDLEVBQWQsQ0FBcEI7QUFDQTtBQUNBLE1BQUlFLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFaLEtBQXlCLE1BQTdCLEVBQXFDO0FBQ25DTixJQUFBQSxJQUFJLENBQUMsaUNBQWlDSSxPQUFPLENBQUNDLEdBQVIsQ0FBWUUsSUFBWixJQUFvQixJQUFyRCxDQUFELENBQUo7QUFDQUwsSUFBQUEsR0FBRyxDQUFDTSxNQUFKLENBQVdKLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRSxJQUFaLElBQW9CLElBQS9CO0FBQ0Q7O0FBRUQsK0JBQVksRUFBRWQsUUFBUSxFQUFFVSxXQUFaLEVBQXlCUixVQUFVLEVBQVZBLFVBQXpCLEVBQXFDSCxNQUFNLEVBQU5BLE1BQXJDLEVBQTZDRixNQUFNLEVBQU5BLE1BQTdDLEVBQVo7QUFDQSxTQUFPO0FBQ0xhLElBQUFBLFdBQVcsRUFBWEEsV0FESztBQUVMTixJQUFBQSxPQUFPLEVBQVBBLE9BRks7QUFHTEwsSUFBQUEsTUFBTSxFQUFOQSxNQUhLLEVBQVA7O0FBS0QsQ0F0Qk0sQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldEFsbE1vZHVsZXMsIGdldFNpbmdsZU1vZHVsZSwgZ2V0QWxsTW9kZWxzIH0gZnJvbSAnLi9jb25maWdQYXJzZXInXG5pbXBvcnQgU2VydmVyIGZyb20gJy4vc2VydmVyJ1xuaW1wb3J0IGFwcGx5U2tpbGxzIGZyb20gJy4vYXBwbHlTa2lsbHMnXG5pbXBvcnQgc3RhcnRDaGFubmVscyBmcm9tICcuL3N0YXJ0Q2hhbm5lbHMnXG5cbmV4cG9ydCBjb25zdCBpbml0ID0gKHsgc2tpbGxzLCBjb25maWcgfSkgPT4ge1xuICBjb25zdCBsb2dnZXIgPSBnZXRTaW5nbGVNb2R1bGUoY29uZmlnLmxvZ2dlcilcbiAgY29uc3QgY2hhbm5lbHMgPSBnZXRBbGxNb2R1bGVzKGNvbmZpZy5jaGFubmVscylcbiAgY29uc3QgcmF3TWlkZGxld2FyZSA9IGdldEFsbE1vZHVsZXMoY29uZmlnLm1pZGRsZXdhcmUpXG4gIGNvbnN0IG1vZGVscyA9IGdldEFsbE1vZGVscyhyYXdNaWRkbGV3YXJlKVxuICBjb25zdCBzdG9yYWdlID0gZ2V0U2luZ2xlTW9kdWxlKGNvbmZpZy5zdG9yYWdlKSh7IGxvZ2dlciwgbW9kZWxzIH0pXG4gIGNvbnN0IG1pZGRsZXdhcmUgPSByYXdNaWRkbGV3YXJlLm1hcChtdyA9PiBtdyh7IHN0b3JhZ2UsIGxvZ2dlciB9KSlcbiAgY29uc3QgaW5mbyA9IGxvZ2dlcignY29yZScsICdpbmZvJylcbiAgY29uc3QgeyBzZXJ2ZXIsIGFwcCB9ID0gU2VydmVyKHsgbG9nZ2VyIH0pXG4gIGNvbnN0IGNvbnRyb2xsZXJzID0gc3RhcnRDaGFubmVscyh7IGNoYW5uZWxzLCBzdG9yYWdlLCBsb2dnZXIsIHNlcnZlciwgYXBwIH0pXG4gIC8vIHN0YXJ0IHNlcnZlclxuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0Jykge1xuICAgIGluZm8oJ3NldHRpbmcgdXAgc2VydmVyIG9uIHBvcnQ6ICcgKyAocHJvY2Vzcy5lbnYuUE9SVCB8fCAzMDAwKSlcbiAgICBhcHAubGlzdGVuKHByb2Nlc3MuZW52LlBPUlQgfHwgMzAwMClcbiAgfVxuXG4gIGFwcGx5U2tpbGxzKHsgY2hhbm5lbHM6IGNvbnRyb2xsZXJzLCBtaWRkbGV3YXJlLCBsb2dnZXIsIHNraWxscyB9KVxuICByZXR1cm4ge1xuICAgIGNvbnRyb2xsZXJzLFxuICAgIHN0b3JhZ2UsXG4gICAgbG9nZ2VyXG4gIH1cbn1cbiJdfQ==