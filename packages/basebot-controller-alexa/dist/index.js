"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;var _botkit = require("botkit");
var _request = _interopRequireDefault(require("request"));
var _alexaResponse = _interopRequireDefault(require("alexa-response"));var _this = void 0;function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}

var AlexaBot = function AlexaBot(configuration) {
  // Create a core botkit bot
  var alexaBot = (0, _botkit.core)(configuration || {});

  alexaBot.on('sessionStart', function (bot, message) {
    bot.send({
      text: configuration.welcomeMessage || 'Hi, how can I help?',
      user: message.user,
      channel: message.channel,
      to: message.user,
      send: message.raw_message.send,
      question: true });

  });

  // customize the bot definition, which will be used when new connections
  // spawn!
  alexaBot.defineBot(function (botkit, config) {
    var bot = {
      type: 'alexa',
      botkit: botkit,
      config: config || {},
      utterances: botkit.utterances };


    bot.startConversation = function (message, cb) {
      botkit.startConversation(_this, message, cb);
    };

    bot.createConversation = function (message, cb) {
      botkit.createConversation(_this, message, cb);
    };

    bot.findConversation = function (message, cb) {
      botkit.debug('CUSTOM FIND CONVO', message.user, message.channel);
      /* eslint-disable no-plusplus */
      for (var t = 0; t < botkit.tasks.length; t++) {
        for (var c = 0; c < botkit.tasks[t].convos.length; c++) {
          var con = botkit.tasks[t].convos[c];
          if (con.isActive() && con.source_message.user === message.user) {
            botkit.debug('FOUND EXISTING CONVO!');
            cb(botkit.tasks[t].convos[c]);
            return;
          }
        }
        /* eslint-enable */
      }
      cb();
    };

    bot.send = function (message) {var
      text = message.text,question = message.question,progressive = message.progressive,send = message.send,typing = message.typing;
      if (progressive || typing) {
        (0, _request["default"])({
          method: 'POST',
          url: "".concat(message.alexa.apiEndpoint, "/v1/directives"),
          auth: {
            bearer: message.alexa.apiAccessToken },

          json: true,
          body: {
            header: {
              requestId: message.channel },

            directive: {
              type: 'VoicePlayer.Speak',
              speech: text } } });



      } else {
        var reply = question ?
        _alexaResponse["default"].ask(text) :
        _alexaResponse["default"].say(text);
        send(reply.build());
      }
    };

    bot.reply = function (src, resp, cb) {
      var message = typeof resp == 'string' ?
      { text: resp } :
      resp;

      message.user = src.user;
      message.channel = src.channel;
      message.to = src.user;
      message.send = src.send;
      message.alexa = src.alexa;

      bot.send(message, cb);
    };

    return bot;
  });

  // set up a web route for receiving incoming requests from alexa
  alexaBot.createWebhookEndpoints = function (webserver, bot) {
    // notify the user that the webhook is running
    alexaBot.log("** Serving webhook endpoint for Alexa Platform at: http://".concat(alexaBot.config.hostname, ":").concat(alexaBot.config.port, "/alexa/receive"));
    webserver.post('/alexa/receive', function (_ref, res) {var body = _ref.body;
      alexaBot.debug('GOT A MESSAGE HOOK');

      var normalizeTypes = {
        LaunchRequest: 'sessionStart',
        IntentRequest: 'message_received',
        SessionEndedRequest: 'conversationEnded'


        // parse the request from alexa
      };var session = body.session,request = body.request,context = body.context;
      var payload = {
        text: request.intent ? request.intent.name : '',
        type: normalizeTypes[request.type] || request.type,
        intent: request.intent,
        slots: request.intent && request.intent.slots,
        user: session && session.user && session.user.userId,
        channel: request && request.requestId,
        timestamp: request.timestamp,
        platform: 'alexa',
        alexa: context && context.System,
        send: function send() {return res.send.apply(res, arguments);}

        // notify botkit we received an event
      };alexaBot.ingest(bot, payload, res);
    });

    return alexaBot;
  };

  return alexaBot;
};var _default =

AlexaBot;exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbIkFsZXhhQm90IiwiY29uZmlndXJhdGlvbiIsImFsZXhhQm90Iiwib24iLCJib3QiLCJtZXNzYWdlIiwic2VuZCIsInRleHQiLCJ3ZWxjb21lTWVzc2FnZSIsInVzZXIiLCJjaGFubmVsIiwidG8iLCJyYXdfbWVzc2FnZSIsInF1ZXN0aW9uIiwiZGVmaW5lQm90IiwiYm90a2l0IiwiY29uZmlnIiwidHlwZSIsInV0dGVyYW5jZXMiLCJzdGFydENvbnZlcnNhdGlvbiIsImNiIiwiY3JlYXRlQ29udmVyc2F0aW9uIiwiZmluZENvbnZlcnNhdGlvbiIsImRlYnVnIiwidCIsInRhc2tzIiwibGVuZ3RoIiwiYyIsImNvbnZvcyIsImNvbiIsImlzQWN0aXZlIiwic291cmNlX21lc3NhZ2UiLCJwcm9ncmVzc2l2ZSIsInR5cGluZyIsIm1ldGhvZCIsInVybCIsImFsZXhhIiwiYXBpRW5kcG9pbnQiLCJhdXRoIiwiYmVhcmVyIiwiYXBpQWNjZXNzVG9rZW4iLCJqc29uIiwiYm9keSIsImhlYWRlciIsInJlcXVlc3RJZCIsImRpcmVjdGl2ZSIsInNwZWVjaCIsInJlcGx5IiwiQWxleGFSZXNwb25zZSIsImFzayIsInNheSIsImJ1aWxkIiwic3JjIiwicmVzcCIsImNyZWF0ZVdlYmhvb2tFbmRwb2ludHMiLCJ3ZWJzZXJ2ZXIiLCJsb2ciLCJob3N0bmFtZSIsInBvcnQiLCJwb3N0IiwicmVzIiwibm9ybWFsaXplVHlwZXMiLCJMYXVuY2hSZXF1ZXN0IiwiSW50ZW50UmVxdWVzdCIsIlNlc3Npb25FbmRlZFJlcXVlc3QiLCJzZXNzaW9uIiwicmVxdWVzdCIsImNvbnRleHQiLCJwYXlsb2FkIiwiaW50ZW50IiwibmFtZSIsInNsb3RzIiwidXNlcklkIiwidGltZXN0YW1wIiwicGxhdGZvcm0iLCJTeXN0ZW0iLCJpbmdlc3QiXSwibWFwcGluZ3MiOiJ1R0FBQTtBQUNBO0FBQ0EsdUU7O0FBRUEsSUFBTUEsUUFBUSxHQUFHLFNBQVhB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OlsiaW1wb3J0IHsgY29yZSB9IGZyb20gJ2JvdGtpdCdcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QnXG5pbXBvcnQgQWxleGFSZXNwb25zZSBmcm9tICdhbGV4YS1yZXNwb25zZSdcblxuY29uc3QgQWxleGFCb3QgPSAoY29uZmlndXJhdGlvbikgPT4ge1xuICAvLyBDcmVhdGUgYSBjb3JlIGJvdGtpdCBib3RcbiAgY29uc3QgYWxleGFCb3QgPSBjb3JlKGNvbmZpZ3VyYXRpb24gfHwge30pXG5cbiAgYWxleGFCb3Qub24oJ3Nlc3Npb25TdGFydCcsIChib3QsIG1lc3NhZ2UpID0+IHtcbiAgICBib3Quc2VuZCh7XG4gICAgICB0ZXh0OiBjb25maWd1cmF0aW9uLndlbGNvbWVNZXNzYWdlIHx8ICdIaSwgaG93IGNhbiBJIGhlbHA/JyxcbiAgICAgIHVzZXI6IG1lc3NhZ2UudXNlcixcbiAgICAgIGNoYW5uZWw6IG1lc3NhZ2UuY2hhbm5lbCxcbiAgICAgIHRvOiBtZXNzYWdlLnVzZXIsXG4gICAgICBzZW5kOiBtZXNzYWdlLnJhd19tZXNzYWdlLnNlbmQsXG4gICAgICBxdWVzdGlvbjogdHJ1ZVxuICAgIH0pXG4gIH0pXG5cbiAgLy8gY3VzdG9taXplIHRoZSBib3QgZGVmaW5pdGlvbiwgd2hpY2ggd2lsbCBiZSB1c2VkIHdoZW4gbmV3IGNvbm5lY3Rpb25zXG4gIC8vIHNwYXduIVxuICBhbGV4YUJvdC5kZWZpbmVCb3QoKGJvdGtpdCwgY29uZmlnKSA9PiB7XG4gICAgY29uc3QgYm90ID0ge1xuICAgICAgdHlwZTogJ2FsZXhhJyxcbiAgICAgIGJvdGtpdCxcbiAgICAgIGNvbmZpZzogY29uZmlnIHx8IHt9LFxuICAgICAgdXR0ZXJhbmNlczogYm90a2l0LnV0dGVyYW5jZXNcbiAgICB9XG5cbiAgICBib3Quc3RhcnRDb252ZXJzYXRpb24gPSAobWVzc2FnZSwgY2IpID0+IHtcbiAgICAgIGJvdGtpdC5zdGFydENvbnZlcnNhdGlvbih0aGlzLCBtZXNzYWdlLCBjYilcbiAgICB9XG5cbiAgICBib3QuY3JlYXRlQ29udmVyc2F0aW9uID0gKG1lc3NhZ2UsIGNiKSA9PiB7XG4gICAgICBib3RraXQuY3JlYXRlQ29udmVyc2F0aW9uKHRoaXMsIG1lc3NhZ2UsIGNiKVxuICAgIH1cblxuICAgIGJvdC5maW5kQ29udmVyc2F0aW9uID0gKG1lc3NhZ2UsIGNiKSA9PiB7XG4gICAgICBib3RraXQuZGVidWcoJ0NVU1RPTSBGSU5EIENPTlZPJywgbWVzc2FnZS51c2VyLCBtZXNzYWdlLmNoYW5uZWwpXG4gICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1wbHVzcGx1cyAqL1xuICAgICAgZm9yIChsZXQgdCA9IDA7IHQgPCBib3RraXQudGFza3MubGVuZ3RoOyB0KyspIHtcbiAgICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCBib3RraXQudGFza3NbdF0uY29udm9zLmxlbmd0aDsgYysrKSB7XG4gICAgICAgICAgY29uc3QgY29uID0gYm90a2l0LnRhc2tzW3RdLmNvbnZvc1tjXVxuICAgICAgICAgIGlmIChjb24uaXNBY3RpdmUoKSAmJiBjb24uc291cmNlX21lc3NhZ2UudXNlciA9PT0gbWVzc2FnZS51c2VyKSB7XG4gICAgICAgICAgICBib3RraXQuZGVidWcoJ0ZPVU5EIEVYSVNUSU5HIENPTlZPIScpXG4gICAgICAgICAgICBjYihib3RraXQudGFza3NbdF0uY29udm9zW2NdKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAvKiBlc2xpbnQtZW5hYmxlICovXG4gICAgICB9XG4gICAgICBjYigpXG4gICAgfVxuXG4gICAgYm90LnNlbmQgPSAobWVzc2FnZSkgPT4ge1xuICAgICAgY29uc3QgeyB0ZXh0LCBxdWVzdGlvbiwgcHJvZ3Jlc3NpdmUsIHNlbmQsIHR5cGluZyB9ID0gbWVzc2FnZVxuICAgICAgaWYgKHByb2dyZXNzaXZlIHx8IHR5cGluZykge1xuICAgICAgICByZXF1ZXN0KHtcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICB1cmw6IGAke21lc3NhZ2UuYWxleGEuYXBpRW5kcG9pbnR9L3YxL2RpcmVjdGl2ZXNgLFxuICAgICAgICAgIGF1dGg6IHtcbiAgICAgICAgICAgIGJlYXJlcjogbWVzc2FnZS5hbGV4YS5hcGlBY2Nlc3NUb2tlblxuICAgICAgICAgIH0sXG4gICAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgICBib2R5OiB7XG4gICAgICAgICAgICBoZWFkZXI6IHtcbiAgICAgICAgICAgICAgcmVxdWVzdElkOiBtZXNzYWdlLmNoYW5uZWxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkaXJlY3RpdmU6IHtcbiAgICAgICAgICAgICAgdHlwZTogJ1ZvaWNlUGxheWVyLlNwZWFrJyxcbiAgICAgICAgICAgICAgc3BlZWNoOiB0ZXh0XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcmVwbHkgPSBxdWVzdGlvblxuICAgICAgICAgID8gQWxleGFSZXNwb25zZS5hc2sodGV4dClcbiAgICAgICAgICA6IEFsZXhhUmVzcG9uc2Uuc2F5KHRleHQpXG4gICAgICAgIHNlbmQocmVwbHkuYnVpbGQoKSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICBib3QucmVwbHkgPSAoc3JjLCByZXNwLCBjYikgPT4ge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IHR5cGVvZiAocmVzcCkgPT0gJ3N0cmluZydcbiAgICAgICAgPyB7IHRleHQ6IHJlc3AgfVxuICAgICAgICA6IHJlc3BcblxuICAgICAgbWVzc2FnZS51c2VyID0gc3JjLnVzZXJcbiAgICAgIG1lc3NhZ2UuY2hhbm5lbCA9IHNyYy5jaGFubmVsXG4gICAgICBtZXNzYWdlLnRvID0gc3JjLnVzZXJcbiAgICAgIG1lc3NhZ2Uuc2VuZCA9IHNyYy5zZW5kXG4gICAgICBtZXNzYWdlLmFsZXhhID0gc3JjLmFsZXhhXG5cbiAgICAgIGJvdC5zZW5kKG1lc3NhZ2UsIGNiKVxuICAgIH1cblxuICAgIHJldHVybiBib3RcbiAgfSlcblxuICAvLyBzZXQgdXAgYSB3ZWIgcm91dGUgZm9yIHJlY2VpdmluZyBpbmNvbWluZyByZXF1ZXN0cyBmcm9tIGFsZXhhXG4gIGFsZXhhQm90LmNyZWF0ZVdlYmhvb2tFbmRwb2ludHMgPSAod2Vic2VydmVyLCBib3QpID0+IHtcbiAgICAvLyBub3RpZnkgdGhlIHVzZXIgdGhhdCB0aGUgd2ViaG9vayBpcyBydW5uaW5nXG4gICAgYWxleGFCb3QubG9nKGAqKiBTZXJ2aW5nIHdlYmhvb2sgZW5kcG9pbnQgZm9yIEFsZXhhIFBsYXRmb3JtIGF0OiBodHRwOi8vJHthbGV4YUJvdC5jb25maWcuaG9zdG5hbWV9OiR7YWxleGFCb3QuY29uZmlnLnBvcnR9L2FsZXhhL3JlY2VpdmVgKVxuICAgIHdlYnNlcnZlci5wb3N0KCcvYWxleGEvcmVjZWl2ZScsICh7IGJvZHkgfSwgcmVzKSA9PiB7XG4gICAgICBhbGV4YUJvdC5kZWJ1ZygnR09UIEEgTUVTU0FHRSBIT09LJylcblxuICAgICAgY29uc3Qgbm9ybWFsaXplVHlwZXMgPSB7XG4gICAgICAgIExhdW5jaFJlcXVlc3Q6ICdzZXNzaW9uU3RhcnQnLFxuICAgICAgICBJbnRlbnRSZXF1ZXN0OiAnbWVzc2FnZV9yZWNlaXZlZCcsXG4gICAgICAgIFNlc3Npb25FbmRlZFJlcXVlc3Q6ICdjb252ZXJzYXRpb25FbmRlZCdcbiAgICAgIH1cblxuICAgICAgLy8gcGFyc2UgdGhlIHJlcXVlc3QgZnJvbSBhbGV4YVxuICAgICAgY29uc3QgeyBzZXNzaW9uLCByZXF1ZXN0LCBjb250ZXh0IH0gPSBib2R5XG4gICAgICBsZXQgcGF5bG9hZCA9IHtcbiAgICAgICAgdGV4dDogcmVxdWVzdC5pbnRlbnQgPyByZXF1ZXN0LmludGVudC5uYW1lIDogJycsXG4gICAgICAgIHR5cGU6IG5vcm1hbGl6ZVR5cGVzW3JlcXVlc3QudHlwZV0gfHwgcmVxdWVzdC50eXBlLFxuICAgICAgICBpbnRlbnQ6IHJlcXVlc3QuaW50ZW50LFxuICAgICAgICBzbG90czogcmVxdWVzdC5pbnRlbnQgJiYgcmVxdWVzdC5pbnRlbnQuc2xvdHMsXG4gICAgICAgIHVzZXI6IHNlc3Npb24gJiYgc2Vzc2lvbi51c2VyICYmIHNlc3Npb24udXNlci51c2VySWQsXG4gICAgICAgIGNoYW5uZWw6IHJlcXVlc3QgJiYgcmVxdWVzdC5yZXF1ZXN0SWQsXG4gICAgICAgIHRpbWVzdGFtcDogcmVxdWVzdC50aW1lc3RhbXAsXG4gICAgICAgIHBsYXRmb3JtOiAnYWxleGEnLFxuICAgICAgICBhbGV4YTogY29udGV4dCAmJiBjb250ZXh0LlN5c3RlbSxcbiAgICAgICAgc2VuZDogKC4uLmFyZ3MpID0+IHJlcy5zZW5kKC4uLmFyZ3MpXG4gICAgICB9XG4gICAgICAvLyBub3RpZnkgYm90a2l0IHdlIHJlY2VpdmVkIGFuIGV2ZW50XG4gICAgICBhbGV4YUJvdC5pbmdlc3QoYm90LCBwYXlsb2FkLCByZXMpXG4gICAgfSlcblxuICAgIHJldHVybiBhbGV4YUJvdFxuICB9XG5cbiAgcmV0dXJuIGFsZXhhQm90XG59XG5cbmV4cG9ydCBkZWZhdWx0IEFsZXhhQm90XG4iXX0=