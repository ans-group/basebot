"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = exports.heard = void 0;var _botkit = require("botkit");
var _request = _interopRequireDefault(require("request"));
var _alexaResponse = _interopRequireDefault(require("alexa-response"));var _this = void 0;function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}

var heard = function heard(storage) {return function (bot, message, next) {
    if (message.alexa && message.intent && message.intent.name && storage && storage.responses) {
      console.log("fetching intent: ".concat(message.intent.name));
      storage.responses.get(message.intent.name).
      then(function (response) {
        if (response) {
          return bot.reply(message, response.response);
        }
        next();
      });
    } else {
      next();
    }
  };};exports.heard = heard;

var AlexaBot = function AlexaBot(configuration) {
  // Create a core botkit bot
  var alexaBot = (0, _botkit.core)(configuration || {});

  alexaBot.on('sessionStart', function (bot, message) {
    if (!message) return;
    bot.send({
      text: configuration.welcomeMessage || 'Hi, how can I help?',
      user: message.user,
      channel: message.channel,
      to: message.user,
      send: message.raw_message.send,
      question: true });

  });

  // customize the bot definition, which will be used when new connections
  // spawn!
  alexaBot.defineBot(function (botkit, config) {
    var bot = {
      type: 'alexa',
      botkit: botkit,
      config: config || {},
      utterances: botkit.utterances };


    bot.startConversation = function (message, cb) {
      botkit.startConversation(_this, message, cb);
    };

    bot.createConversation = function (message, cb) {
      botkit.createConversation(_this, message, cb);
    };

    bot.findConversation = function (message, cb) {
      botkit.debug('CUSTOM FIND CONVO', message.user, message.channel);
      /* eslint-disable no-plusplus */
      for (var t = 0; t < botkit.tasks.length; t++) {
        for (var c = 0; c < botkit.tasks[t].convos.length; c++) {
          var con = botkit.tasks[t].convos[c];
          if (con.isActive() && con.source_message.user === message.user) {
            botkit.debug('FOUND EXISTING CONVO!');
            cb(botkit.tasks[t].convos[c]);
            return;
          }
        }
        /* eslint-enable */
      }
      cb();
    };

    bot.send = function (message) {var
      text = message.text,question = message.question,progressive = message.progressive,send = message.send,typing = message.typing;
      if (progressive || typing) {
        (0, _request["default"])({
          method: 'POST',
          url: "".concat(message.alexa.apiEndpoint, "/v1/directives"),
          auth: {
            bearer: message.alexa.apiAccessToken },

          json: true,
          body: {
            header: {
              requestId: message.channel },

            directive: {
              type: 'VoicePlayer.Speak',
              speech: text } } });



      } else {
        var reply = question ?
        _alexaResponse["default"].ask(text) :
        _alexaResponse["default"].say(text);
        send(reply.build());
      }
    };

    bot.reply = function (src, resp, cb) {
      var message = typeof resp === 'string' ?
      { text: resp } :
      resp;

      message.user = src.user;
      message.channel = src.channel;
      message.to = src.user;
      message.send = src.send;
      message.alexa = src.alexa;

      bot.send(message, cb);
    };

    return bot;
  });

  // set up a web route for receiving incoming requests from alexa
  alexaBot.createWebhookEndpoints = function (webserver, bot) {
    // notify the user that the webhook is running
    alexaBot.log("** Serving webhook endpoint for Alexa Platform at: http://".concat(alexaBot.config.hostname, ":").concat(alexaBot.config.port, "/alexa/receive"));
    webserver.post('/alexa/receive', function (_ref, res) {var body = _ref.body;
      alexaBot.debug('GOT A MESSAGE HOOK');

      var normalizeTypes = {
        LaunchRequest: 'sessionStart',
        IntentRequest: 'message_received',
        SessionEndedRequest: 'conversationEnded' };var


      session = body.session,request = body.request,context = body.context;
      var userIdArr = session && session.user && session.user.userId && session.user.userId.split('.');
      var userId = userIdArr && userIdArr[userIdArr.length - 1];
      // parse the request from alexa
      var payload = {
        text: request.intent ? request.intent.name : '',
        type: normalizeTypes[request.type] || request.type,
        intent: request.intent,
        slots: request.intent && request.intent.slots,
        user: userId,
        channel: request && request.requestId,
        timestamp: request.timestamp,
        platform: 'alexa',
        alexa: context && context.System,
        send: function send() {return res.send.apply(res, arguments);}

        // notify botkit we received an event
      };alexaBot.ingest(bot, payload, res);
    });

    return alexaBot;
  };

  return alexaBot;
};var _default =

function _default(_ref2) {var storage = _ref2.storage,logger = _ref2.logger;
  var controller = AlexaBot({ storage: storage });
  var info = logger('channels:alexa', 'info');
  return {
    controller: controller,
    name: 'alexa',
    start: function start(_ref3) {var app = _ref3.app;
      var bot = controller.spawn({});
      controller.createWebhookEndpoints(app, bot);
      controller.startTicking();
      info('Azure bot listening');
    } };

};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImhlYXJkIiwic3RvcmFnZSIsImJvdCIsIm1lc3NhZ2UiLCJuZXh0IiwiYWxleGEiLCJpbnRlbnQiLCJuYW1lIiwicmVzcG9uc2VzIiwiY29uc29sZSIsImxvZyIsImdldCIsInRoZW4iLCJyZXNwb25zZSIsInJlcGx5IiwiQWxleGFCb3QiLCJjb25maWd1cmF0aW9uIiwiYWxleGFCb3QiLCJvbiIsInNlbmQiLCJ0ZXh0Iiwid2VsY29tZU1lc3NhZ2UiLCJ1c2VyIiwiY2hhbm5lbCIsInRvIiwicmF3X21lc3NhZ2UiLCJxdWVzdGlvbiIsImRlZmluZUJvdCIsImJvdGtpdCIsImNvbmZpZyIsInR5cGUiLCJ1dHRlcmFuY2VzIiwic3RhcnRDb252ZXJzYXRpb24iLCJjYiIsImNyZWF0ZUNvbnZlcnNhdGlvbiIsImZpbmRDb252ZXJzYXRpb24iLCJkZWJ1ZyIsInQiLCJ0YXNrcyIsImxlbmd0aCIsImMiLCJjb252b3MiLCJjb24iLCJpc0FjdGl2ZSIsInNvdXJjZV9tZXNzYWdlIiwicHJvZ3Jlc3NpdmUiLCJ0eXBpbmciLCJtZXRob2QiLCJ1cmwiLCJhcGlFbmRwb2ludCIsImF1dGgiLCJiZWFyZXIiLCJhcGlBY2Nlc3NUb2tlbiIsImpzb24iLCJib2R5IiwiaGVhZGVyIiwicmVxdWVzdElkIiwiZGlyZWN0aXZlIiwic3BlZWNoIiwiQWxleGFSZXNwb25zZSIsImFzayIsInNheSIsImJ1aWxkIiwic3JjIiwicmVzcCIsImNyZWF0ZVdlYmhvb2tFbmRwb2ludHMiLCJ3ZWJzZXJ2ZXIiLCJob3N0bmFtZSIsInBvcnQiLCJwb3N0IiwicmVzIiwibm9ybWFsaXplVHlwZXMiLCJMYXVuY2hSZXF1ZXN0IiwiSW50ZW50UmVxdWVzdCIsIlNlc3Npb25FbmRlZFJlcXVlc3QiLCJzZXNzaW9uIiwicmVxdWVzdCIsImNvbnRleHQiLCJ1c2VySWRBcnIiLCJ1c2VySWQiLCJzcGxpdCIsInBheWxvYWQiLCJzbG90cyIsInRpbWVzdGFtcCIsInBsYXRmb3JtIiwiU3lzdGVtIiwiaW5nZXN0IiwibG9nZ2VyIiwiY29udHJvbGxlciIsImluZm8iLCJzdGFydCIsImFwcCIsInNwYXduIiwic3RhcnRUaWNraW5nIl0sIm1hcHBpbmdzIjoidUhBQUE7QUFDQTtBQUNBLHVFOztBQUVPLElBQU1BLEtBQUssR0FBRyxTQUFSQSxLQUFRLENBQUFDLE9BQU8sVUFBSSxVQUFDQyxHQUFELEVBQU1DLE9BQU4sRUFBZUMsSUFBZixFQUF3QjtBQUN0RCxRQUFJRCxPQUFPLENBQUNFLEtBQVIsSUFBaUJGLE9BQU8sQ0FBQ0csTUFBekIsSUFBbUNILE9BQU8sQ0FBQ0csTUFBUixDQUFlQyxJQUFsRCxJQUEwRE4sT0FBMUQsSUFBcUVBLE9BQU8sQ0FBQ08sU0FBakYsRUFBNEY7QUFDMUZDLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUiw0QkFBZ0NQLE9BQU8sQ0FBQ0csTUFBUixDQUFlQyxJQUEvQztBQUNBTixNQUFBQSxPQUFPLENBQUNPLFNBQVIsQ0FBa0JHLEdBQWxCLENBQXNCUixPQUFPLENBQUNHLE1BQVIsQ0FBZUMsSUFBckM7QUFDR0ssTUFBQUEsSUFESCxDQUNRLFVBQUFDLFFBQVEsRUFBSTtBQUNoQixZQUFJQSxRQUFKLEVBQWM7QUFDWixpQkFBT1gsR0FBRyxDQUFDWSxLQUFKLENBQVVYLE9BQVYsRUFBbUJVLFFBQVEsQ0FBQ0EsUUFBNUIsQ0FBUDtBQUNEO0FBQ0RULFFBQUFBLElBQUk7QUFDTCxPQU5IO0FBT0QsS0FURCxNQVNPO0FBQ0xBLE1BQUFBLElBQUk7QUFDTDtBQUNGLEdBYjJCLEVBQXJCLEM7O0FBZVAsSUFBTVcsUUFBUSxHQUFHLFNBQVhBLFFBQVcsQ0FBQ0MsYUFBRCxFQUFtQjtBQUNsQztBQUNBLE1BQU1DLFFBQVEsR0FBRyxrQkFBS0QsYUFBYSxJQUFJLEVBQXRCLENBQWpCOztBQUVBQyxFQUFBQSxRQUFRLENBQUNDLEVBQVQsQ0FBWSxjQUFaLEVBQTRCLFVBQUNoQixHQUFELEVBQU1DLE9BQU4sRUFBa0I7QUFDNUMsUUFBSSxDQUFD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OztBQTZCQSxXQUFPckQsUUFBUDtBQUNELEdBakNEOztBQW1DQSxTQUFPQSxRQUFQO0FBQ0QsQ0FySUQsQzs7QUF1SWUseUJBQXlCLEtBQXRCaEIsT0FBc0IsU0FBdEJBLE9BQXNCLENBQWJzRixNQUFhLFNBQWJBLE1BQWE7QUFDdEMsTUFBTUMsVUFBVSxHQUFHekUsUUFBUSxDQUFDLEVBQUVkLE9BQU8sRUFBUEEsT0FBRixFQUFELENBQTNCO0FBQ0EsTUFBTXdGLElBQUksR0FBR0YsTUFBTSxDQUFDLGdCQUFELEVBQW1CLE1BQW5CLENBQW5CO0FBQ0EsU0FBTztBQUNMQyxJQUFBQSxVQUFVLEVBQVZBLFVBREs7QUFFTGpGLElBQUFBLElBQUksRUFBRSxPQUZEO0FBR0xtRixJQUFBQSxLQUhLLHdCQUdVLEtBQVBDLEdBQU8sU0FBUEEsR0FBTztBQUNiLFVBQU16RixHQUFHLEdBQUdzRixVQUFVLENBQUNJLEtBQVgsQ0FBaUIsRUFBakIsQ0FBWjtBQUNBSixNQUFBQSxVQUFVLENBQUN2QixzQkFBWCxDQUFrQzBCLEdBQWxDLEVBQXVDekYsR0FBdkM7QUFDQXNGLE1BQUFBLFVBQVUsQ0FBQ0ssWUFBWDtBQUNBSixNQUFBQSxJQUFJLENBQUMscUJBQUQsQ0FBSjtBQUNELEtBUkksRUFBUDs7QUFVRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29yZSB9IGZyb20gJ2JvdGtpdCdcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QnXG5pbXBvcnQgQWxleGFSZXNwb25zZSBmcm9tICdhbGV4YS1yZXNwb25zZSdcblxuZXhwb3J0IGNvbnN0IGhlYXJkID0gc3RvcmFnZSA9PiAoYm90LCBtZXNzYWdlLCBuZXh0KSA9PiB7XG4gIGlmIChtZXNzYWdlLmFsZXhhICYmIG1lc3NhZ2UuaW50ZW50ICYmIG1lc3NhZ2UuaW50ZW50Lm5hbWUgJiYgc3RvcmFnZSAmJiBzdG9yYWdlLnJlc3BvbnNlcykge1xuICAgIGNvbnNvbGUubG9nKGBmZXRjaGluZyBpbnRlbnQ6ICR7bWVzc2FnZS5pbnRlbnQubmFtZX1gKVxuICAgIHN0b3JhZ2UucmVzcG9uc2VzLmdldChtZXNzYWdlLmludGVudC5uYW1lKVxuICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgICAgICByZXR1cm4gYm90LnJlcGx5KG1lc3NhZ2UsIHJlc3BvbnNlLnJlc3BvbnNlKVxuICAgICAgICB9XG4gICAgICAgIG5leHQoKVxuICAgICAgfSlcbiAgfSBlbHNlIHtcbiAgICBuZXh0KClcbiAgfVxufVxuXG5jb25zdCBBbGV4YUJvdCA9IChjb25maWd1cmF0aW9uKSA9PiB7XG4gIC8vIENyZWF0ZSBhIGNvcmUgYm90a2l0IGJvdFxuICBjb25zdCBhbGV4YUJvdCA9IGNvcmUoY29uZmlndXJhdGlvbiB8fCB7fSlcblxuICBhbGV4YUJvdC5vbignc2Vzc2lvblN0YXJ0JywgKGJvdCwgbWVzc2FnZSkgPT4ge1xuICAgIGlmICghbWVzc2FnZSkgcmV0dXJuXG4gICAgYm90LnNlbmQoe1xuICAgICAgdGV4dDogY29uZmlndXJhdGlvbi53ZWxjb21lTWVzc2FnZSB8fCAnSGksIGhvdyBjYW4gSSBoZWxwPycsXG4gICAgICB1c2VyOiBtZXNzYWdlLnVzZXIsXG4gICAgICBjaGFubmVsOiBtZXNzYWdlLmNoYW5uZWwsXG4gICAgICB0bzogbWVzc2FnZS51c2VyLFxuICAgICAgc2VuZDogbWVzc2FnZS5yYXdfbWVzc2FnZS5zZW5kLFxuICAgICAgcXVlc3Rpb246IHRydWVcbiAgICB9KVxuICB9KVxuXG4gIC8vIGN1c3RvbWl6ZSB0aGUgYm90IGRlZmluaXRpb24sIHdoaWNoIHdpbGwgYmUgdXNlZCB3aGVuIG5ldyBjb25uZWN0aW9uc1xuICAvLyBzcGF3biFcbiAgYWxleGFCb3QuZGVmaW5lQm90KChib3RraXQsIGNvbmZpZykgPT4ge1xuICAgIGNvbnN0IGJvdCA9IHtcbiAgICAgIHR5cGU6ICdhbGV4YScsXG4gICAgICBib3RraXQsXG4gICAgICBjb25maWc6IGNvbmZpZyB8fCB7fSxcbiAgICAgIHV0dGVyYW5jZXM6IGJvdGtpdC51dHRlcmFuY2VzXG4gICAgfVxuXG4gICAgYm90LnN0YXJ0Q29udmVyc2F0aW9uID0gKG1lc3NhZ2UsIGNiKSA9PiB7XG4gICAgICBib3RraXQuc3RhcnRDb252ZXJzYXRpb24odGhpcywgbWVzc2FnZSwgY2IpXG4gICAgfVxuXG4gICAgYm90LmNyZWF0ZUNvbnZlcnNhdGlvbiA9IChtZXNzYWdlLCBjYikgPT4ge1xuICAgICAgYm90a2l0LmNyZWF0ZUNvbnZlcnNhdGlvbih0aGlzLCBtZXNzYWdlLCBjYilcbiAgICB9XG5cbiAgICBib3QuZmluZENvbnZlcnNhdGlvbiA9IChtZXNzYWdlLCBjYikgPT4ge1xuICAgICAgYm90a2l0LmRlYnVnKCdDVVNUT00gRklORCBDT05WTycsIG1lc3NhZ2UudXNlciwgbWVzc2FnZS5jaGFubmVsKVxuICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tcGx1c3BsdXMgKi9cbiAgICAgIGZvciAobGV0IHQgPSAwOyB0IDwgYm90a2l0LnRhc2tzLmxlbmd0aDsgdCsrKSB7XG4gICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgYm90a2l0LnRhc2tzW3RdLmNvbnZvcy5sZW5ndGg7IGMrKykge1xuICAgICAgICAgIGNvbnN0IGNvbiA9IGJvdGtpdC50YXNrc1t0XS5jb252b3NbY11cbiAgICAgICAgICBpZiAoY29uLmlzQWN0aXZlKCkgJiYgY29uLnNvdXJjZV9tZXNzYWdlLnVzZXIgPT09IG1lc3NhZ2UudXNlcikge1xuICAgICAgICAgICAgYm90a2l0LmRlYnVnKCdGT1VORCBFWElTVElORyBDT05WTyEnKVxuICAgICAgICAgICAgY2IoYm90a2l0LnRhc2tzW3RdLmNvbnZvc1tjXSlcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgLyogZXNsaW50LWVuYWJsZSAqL1xuICAgICAgfVxuICAgICAgY2IoKVxuICAgIH1cblxuICAgIGJvdC5zZW5kID0gKG1lc3NhZ2UpID0+IHtcbiAgICAgIGNvbnN0IHsgdGV4dCwgcXVlc3Rpb24sIHByb2dyZXNzaXZlLCBzZW5kLCB0eXBpbmcgfSA9IG1lc3NhZ2VcbiAgICAgIGlmIChwcm9ncmVzc2l2ZSB8fCB0eXBpbmcpIHtcbiAgICAgICAgcmVxdWVzdCh7XG4gICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgdXJsOiBgJHttZXNzYWdlLmFsZXhhLmFwaUVuZHBvaW50fS92MS9kaXJlY3RpdmVzYCxcbiAgICAgICAgICBhdXRoOiB7XG4gICAgICAgICAgICBiZWFyZXI6IG1lc3NhZ2UuYWxleGEuYXBpQWNjZXNzVG9rZW5cbiAgICAgICAgICB9LFxuICAgICAgICAgIGpzb246IHRydWUsXG4gICAgICAgICAgYm9keToge1xuICAgICAgICAgICAgaGVhZGVyOiB7XG4gICAgICAgICAgICAgIHJlcXVlc3RJZDogbWVzc2FnZS5jaGFubmVsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZGlyZWN0aXZlOiB7XG4gICAgICAgICAgICAgIHR5cGU6ICdWb2ljZVBsYXllci5TcGVhaycsXG4gICAgICAgICAgICAgIHNwZWVjaDogdGV4dFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlcGx5ID0gcXVlc3Rpb25cbiAgICAgICAgICA/IEFsZXhhUmVzcG9uc2UuYXNrKHRleHQpXG4gICAgICAgICAgOiBBbGV4YVJlc3BvbnNlLnNheSh0ZXh0KVxuICAgICAgICBzZW5kKHJlcGx5LmJ1aWxkKCkpXG4gICAgICB9XG4gICAgfVxuXG4gICAgYm90LnJlcGx5ID0gKHNyYywgcmVzcCwgY2IpID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0eXBlb2YgKHJlc3ApID09PSAnc3RyaW5nJ1xuICAgICAgICA/IHsgdGV4dDogcmVzcCB9XG4gICAgICAgIDogcmVzcFxuXG4gICAgICBtZXNzYWdlLnVzZXIgPSBzcmMudXNlclxuICAgICAgbWVzc2FnZS5jaGFubmVsID0gc3JjLmNoYW5uZWxcbiAgICAgIG1lc3NhZ2UudG8gPSBzcmMudXNlclxuICAgICAgbWVzc2FnZS5zZW5kID0gc3JjLnNlbmRcbiAgICAgIG1lc3NhZ2UuYWxleGEgPSBzcmMuYWxleGFcblxuICAgICAgYm90LnNlbmQobWVzc2FnZSwgY2IpXG4gICAgfVxuXG4gICAgcmV0dXJuIGJvdFxuICB9KVxuXG4gIC8vIHNldCB1cCBhIHdlYiByb3V0ZSBmb3IgcmVjZWl2aW5nIGluY29taW5nIHJlcXVlc3RzIGZyb20gYWxleGFcbiAgYWxleGFCb3QuY3JlYXRlV2ViaG9va0VuZHBvaW50cyA9ICh3ZWJzZXJ2ZXIsIGJvdCkgPT4ge1xuICAgIC8vIG5vdGlmeSB0aGUgdXNlciB0aGF0IHRoZSB3ZWJob29rIGlzIHJ1bm5pbmdcbiAgICBhbGV4YUJvdC5sb2coYCoqIFNlcnZpbmcgd2ViaG9vayBlbmRwb2ludCBmb3IgQWxleGEgUGxhdGZvcm0gYXQ6IGh0dHA6Ly8ke2FsZXhhQm90LmNvbmZpZy5ob3N0bmFtZX06JHthbGV4YUJvdC5jb25maWcucG9ydH0vYWxleGEvcmVjZWl2ZWApXG4gICAgd2Vic2VydmVyLnBvc3QoJy9hbGV4YS9yZWNlaXZlJywgKHsgYm9keSB9LCByZXMpID0+IHtcbiAgICAgIGFsZXhhQm90LmRlYnVnKCdHT1QgQSBNRVNTQUdFIEhPT0snKVxuXG4gICAgICBjb25zdCBub3JtYWxpemVUeXBlcyA9IHtcbiAgICAgICAgTGF1bmNoUmVxdWVzdDogJ3Nlc3Npb25TdGFydCcsXG4gICAgICAgIEludGVudFJlcXVlc3Q6ICdtZXNzYWdlX3JlY2VpdmVkJyxcbiAgICAgICAgU2Vzc2lvbkVuZGVkUmVxdWVzdDogJ2NvbnZlcnNhdGlvbkVuZGVkJ1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7IHNlc3Npb24sIHJlcXVlc3QsIGNvbnRleHQgfSA9IGJvZHlcbiAgICAgIGNvbnN0IHVzZXJJZEFyciA9IHNlc3Npb24gJiYgc2Vzc2lvbi51c2VyICYmIHNlc3Npb24udXNlci51c2VySWQgJiYgc2Vzc2lvbi51c2VyLnVzZXJJZC5zcGxpdCgnLicpXG4gICAgICBjb25zdCB1c2VySWQgPSB1c2VySWRBcnIgJiYgdXNlcklkQXJyW3VzZXJJZEFyci5sZW5ndGggLSAxXVxuICAgICAgLy8gcGFyc2UgdGhlIHJlcXVlc3QgZnJvbSBhbGV4YVxuICAgICAgbGV0IHBheWxvYWQgPSB7XG4gICAgICAgIHRleHQ6IHJlcXVlc3QuaW50ZW50ID8gcmVxdWVzdC5pbnRlbnQubmFtZSA6ICcnLFxuICAgICAgICB0eXBlOiBub3JtYWxpemVUeXBlc1tyZXF1ZXN0LnR5cGVdIHx8IHJlcXVlc3QudHlwZSxcbiAgICAgICAgaW50ZW50OiByZXF1ZXN0LmludGVudCxcbiAgICAgICAgc2xvdHM6IHJlcXVlc3QuaW50ZW50ICYmIHJlcXVlc3QuaW50ZW50LnNsb3RzLFxuICAgICAgICB1c2VyOiB1c2VySWQsXG4gICAgICAgIGNoYW5uZWw6IHJlcXVlc3QgJiYgcmVxdWVzdC5yZXF1ZXN0SWQsXG4gICAgICAgIHRpbWVzdGFtcDogcmVxdWVzdC50aW1lc3RhbXAsXG4gICAgICAgIHBsYXRmb3JtOiAnYWxleGEnLFxuICAgICAgICBhbGV4YTogY29udGV4dCAmJiBjb250ZXh0LlN5c3RlbSxcbiAgICAgICAgc2VuZDogKC4uLmFyZ3MpID0+IHJlcy5zZW5kKC4uLmFyZ3MpXG4gICAgICB9XG4gICAgICAvLyBub3RpZnkgYm90a2l0IHdlIHJlY2VpdmVkIGFuIGV2ZW50XG4gICAgICBhbGV4YUJvdC5pbmdlc3QoYm90LCBwYXlsb2FkLCByZXMpXG4gICAgfSlcblxuICAgIHJldHVybiBhbGV4YUJvdFxuICB9XG5cbiAgcmV0dXJuIGFsZXhhQm90XG59XG5cbmV4cG9ydCBkZWZhdWx0ICh7IHN0b3JhZ2UsIGxvZ2dlciB9KSA9PiB7XG4gIGNvbnN0IGNvbnRyb2xsZXIgPSBBbGV4YUJvdCh7IHN0b3JhZ2UgfSlcbiAgY29uc3QgaW5mbyA9IGxvZ2dlcignY2hhbm5lbHM6YWxleGEnLCAnaW5mbycpXG4gIHJldHVybiB7XG4gICAgY29udHJvbGxlcixcbiAgICBuYW1lOiAnYWxleGEnLFxuICAgIHN0YXJ0KHsgYXBwIH0pIHtcbiAgICAgIGNvbnN0IGJvdCA9IGNvbnRyb2xsZXIuc3Bhd24oe30pXG4gICAgICBjb250cm9sbGVyLmNyZWF0ZVdlYmhvb2tFbmRwb2ludHMoYXBwLCBib3QpXG4gICAgICBjb250cm9sbGVyLnN0YXJ0VGlja2luZygpXG4gICAgICBpbmZvKCdBenVyZSBib3QgbGlzdGVuaW5nJylcbiAgICB9XG4gIH1cbn1cbiJdfQ==