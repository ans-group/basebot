"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;var _request = _interopRequireDefault(require("request"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}function _readOnlyError(name) {throw new Error("\"" + name + "\" is read-only");}var _default =

function _default(logger) {
  var error = logger('middleware:luis', 'error');
  if (!process.env.LUIS_URI) {
    error('LUIS_URI must be set');
  }

  return { receive: receive, hearIntent: hearIntent };

  function receive() {
    var serviceUri = process.env.LUIS_URI.trim();
    if (serviceUri.lastIndexOf('&q=') != serviceUri.length - 3) {
      serviceUri += (_readOnlyError("serviceUri"), '&q=');
    }
    var minThreshold = process.env.LUIS_MIN_THRESHOLD || 0.1;
    var captureThreshold = process.env.LUIS_CAPTURE_THRESHOLD || 0.7;
    return function (bot, message, next) {
      // We will only process the text and either there's no topIntent
      // or the score for the topIntent is below the captureThreshold.
      if (message.text && (
      !message.topIntent || message.topIntent.score < captureThreshold)) {
        var uri = serviceUri + encodeURIComponent(message.text);
        _request["default"].get(uri, function (err, res, body) {
          try {
            if (!err) {
              var result = JSON.parse(body);

              if (result.topScoringIntent && result.topScoringIntent.intent !== 'None') {
                // API v2.0
                message.topIntent = result.topScoringIntent;
                message.entities = result.entities || [];
                message.action = result.topScoringIntent.actions && result.topScoringIntent.actions[0].triggered ? result.topScoringIntent.actions[0] : null;
              } else if (!result.topScoringIntent) {
                // API v1.0

                // Intents for the builtin Cortana app don't return a score.
                if (result.intents.length == 1 && !result.intents[0].hasOwnProperty('score')) {
                  result.intents[0].score = 1.0;
                }

                // Find top intent
                // - Only return entities for the model with the top intent.
                for (var i = 0; i < result.intents.length; i++) {
                  var intent = result.intents[i];
                  if (intent.score > minThreshold && (
                  !message.topIntent || intent.score > message.topIntent.score)) {
                    message.topIntent = intent;
                    message.entities = result.entities || [];
                    message.action = intent.actions && intent.actions[0].triggered ? intent.actions[0] : null;
                  }
                }
              }
            } else {
              console.error(err.toString());
            }
          } catch (e) {
            console.error(e.toString());
          }
          next();
        });
      } else {
        next();
      }
    };
  }

  function hearIntent(tests, _ref) {var topIntent = _ref.topIntent;
    if (topIntent) {
      var intent = topIntent.intent.toLowerCase();
      for (var i = 0; i < tests.length; i++) {
        if (tests[i].trim().toLowerCase() == intent) {
          return true;
        }
      }
    }
    return false;
  }
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImVycm9yIiwicHJvY2VzcyIsImVudiIsIkxVSVNfVVJJIiwicmVjZWl2ZSIsImhlYXJJbnRlbnQiLCJzZXJ2aWNlVXJpIiwidHJpbSIsImxhc3RJbmRleE9mIiwibGVuZ3RoIiwibWluVGhyZXNob2xkIiwiTFVJU19NSU5fVEhSRVNIT0xEIiwiY2FwdHVyZVRocmVzaG9sZCIsIkxVSVNfQ0FQVFVSRV9USFJFU0hPTEQiLCJib3QiLCJtZXNzYWdlIiwibmV4dCIsInRleHQiLCJ0b3BJbnRlbnQiLCJzY29yZSIsInVyaSIsImVuY29kZVVSSUNvbXBvbmVudCIsInJlcXVlc3QiLCJnZXQiLCJlcnIiLCJyZXMiLCJib2R5IiwicmVzdWx0IiwiSlNPTiIsInBhcnNlIiwidG9wU2NvcmluZ0ludGVudCIsImludGVudCIsImVudGl0aWVzIiwiYWN0aW9uIiwiYWN0aW9ucyIsInRyaWdnZXJlZCIsImludGVudHMiLCJoYXNPd25Qcm9wZXJ0eSIsImkiLCJjb25zb2xlIiwidG9TdHJpbmciLCJlIiwidGVzdHMiLCJ0b0xvd2VyQ2FzZSJdLCJtYXBwaW5ncyI6InVHQUFBLDBEOztBQUVlLGtCQUFDQSxNQUFELEVBQVk7QUFDekIsTUFBTUMsS0FBSyxHQUFHRCxNQUFNLENBQUMsaUJBQUQsRUFBb0IsT0FBcEIsQ0FBcEI7QUFDQSxNQUFJLENBQUNFLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFqQixFQUEyQjtBQUN6QkgsSUFBQUEsS0FBSyxDQUFDLHNCQUFELENBQUw7QUFDRDs7QUFFRCxTQUFPLEVBQUVJLE9BQU8sRUFBUEEsT0FBRixFQUFXQyxVQUFVLEVBQVZBLFVBQVgsRUFBUDs7QUFFQSxXQUFTRCxPQUFULEdBQW1CO0FBQ2pCLFFBQU1FLFVBQVUsR0FBR0wsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQVosQ0FBcUJJLElBQXJCLEVBQW5CO0FBQ0EsUUFBSUQsVUFBVSxDQUFDRSxXQUFYLENBQXVCLEtB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U0FBcEMsR0FBZ0RKLE1BQU0sQ0FBQ0csT0FBUCxDQUFlLENBQWYsQ0FBaEQsR0FBb0UsSUFBckY7QUFDRDtBQUNGO0FBQ0Y7QUFDRixhQTVCRCxNQTRCTztBQUNMSyxjQUFBQSxPQUFPLENBQUN2QyxLQUFSLENBQWN3QixHQUFHLENBQUNnQixRQUFKLEVBQWQ7QUFDRDtBQUNGLFdBaENELENBZ0NFLE9BQU9DLENBQVAsRUFBVTtBQUNWRixZQUFBQSxPQUFPLENBQUN2QyxLQUFSLENBQWN5QyxDQUFDLENBQUNELFFBQUYsRUFBZDtBQUNEO0FBQ0R4QixVQUFBQSxJQUFJO0FBQ0wsU0FyQ0Q7QUFzQ0QsT0F6Q0QsTUF5Q087QUFDTEEsUUFBQUEsSUFBSTtBQUNMO0FBQ0YsS0EvQ0Q7QUFnREQ7O0FBRUQsV0FBU1gsVUFBVCxDQUFvQnFDLEtBQXBCLFFBQTBDLEtBQWJ4QixTQUFhLFFBQWJBLFNBQWE7QUFDeEMsUUFBSUEsU0FBSixFQUFlO0FBQ2IsVUFBTWEsTUFBTSxHQUFHYixTQUFTLENBQUNhLE1BQVYsQ0FBaUJZLFdBQWpCLEVBQWY7QUFDQSxXQUFLLElBQUlMLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdJLEtBQUssQ0FBQ2pDLE1BQTFCLEVBQWtDNkIsQ0FBQyxFQUFuQyxFQUF1QztBQUNyQyxZQUFJSSxLQUFLLENBQUNKLENBQUQsQ0FBTCxDQUFTL0IsSUFBVCxHQUFnQm9DLFdBQWhCLE1BQWlDWixNQUFyQyxFQUE2QztBQUMzQyxpQkFBTyxJQUFQO0FBQ0Q7QUFDRjtBQUNGO0FBQ0QsV0FBTyxLQUFQO0FBQ0Q7QUFDRixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdCdcblxuZXhwb3J0IGRlZmF1bHQgKGxvZ2dlcikgPT4ge1xuICBjb25zdCBlcnJvciA9IGxvZ2dlcignbWlkZGxld2FyZTpsdWlzJywgJ2Vycm9yJylcbiAgaWYgKCFwcm9jZXNzLmVudi5MVUlTX1VSSSkge1xuICAgIGVycm9yKCdMVUlTX1VSSSBtdXN0IGJlIHNldCcpXG4gIH1cblxuICByZXR1cm4geyByZWNlaXZlLCBoZWFySW50ZW50IH1cblxuICBmdW5jdGlvbiByZWNlaXZlKCkge1xuICAgIGNvbnN0IHNlcnZpY2VVcmkgPSBwcm9jZXNzLmVudi5MVUlTX1VSSS50cmltKClcbiAgICBpZiAoc2VydmljZVVyaS5sYXN0SW5kZXhPZignJnE9JykgIT0gc2VydmljZVVyaS5sZW5ndGggLSAzKSB7XG4gICAgICBzZXJ2aWNlVXJpICs9ICcmcT0nXG4gICAgfVxuICAgIGNvbnN0IG1pblRocmVzaG9sZCA9IHByb2Nlc3MuZW52LkxVSVNfTUlOX1RIUkVTSE9MRCB8fCAwLjFcbiAgICBjb25zdCBjYXB0dXJlVGhyZXNob2xkID0gcHJvY2Vzcy5lbnYuTFVJU19DQVBUVVJFX1RIUkVTSE9MRCB8fCAwLjdcbiAgICByZXR1cm4gKGJvdCwgbWVzc2FnZSwgbmV4dCkgPT4ge1xuICAgICAgLy8gV2Ugd2lsbCBvbmx5IHByb2Nlc3MgdGhlIHRleHQgYW5kIGVpdGhlciB0aGVyZSdzIG5vIHRvcEludGVudFxuICAgICAgLy8gb3IgdGhlIHNjb3JlIGZvciB0aGUgdG9wSW50ZW50IGlzIGJlbG93IHRoZSBjYXB0dXJlVGhyZXNob2xkLlxuICAgICAgaWYgKG1lc3NhZ2UudGV4dCAmJlxuICAgICAgICAoIW1lc3NhZ2UudG9wSW50ZW50IHx8IG1lc3NhZ2UudG9wSW50ZW50LnNjb3JlIDwgY2FwdHVyZVRocmVzaG9sZCkpIHtcbiAgICAgICAgY29uc3QgdXJpID0gc2VydmljZVVyaSArIGVuY29kZVVSSUNvbXBvbmVudChtZXNzYWdlLnRleHQpXG4gICAgICAgIHJlcXVlc3QuZ2V0KHVyaSwgKGVyciwgcmVzLCBib2R5KSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IEpTT04ucGFyc2UoYm9keSlcblxuICAgICAgICAgICAgICBpZiAocmVzdWx0LnRvcFNjb3JpbmdJbnRlbnQgJiYgcmVzdWx0LnRvcFNjb3JpbmdJbnRlbnQuaW50ZW50ICE9PSAnTm9uZScpIHtcbiAgICAgICAgICAgICAgICAvLyBBUEkgdjIuMFxuICAgICAgICAgICAgICAgIG1lc3NhZ2UudG9wSW50ZW50ID0gcmVzdWx0LnRvcFNjb3JpbmdJbnRlbnRcbiAgICAgICAgICAgICAgICBtZXNzYWdlLmVudGl0aWVzID0gcmVzdWx0LmVudGl0aWVzIHx8IFtdXG4gICAgICAgICAgICAgICAgbWVzc2FnZS5hY3Rpb24gPSByZXN1bHQudG9wU2NvcmluZ0ludGVudC5hY3Rpb25zICYmIHJlc3VsdC50b3BTY29yaW5nSW50ZW50LmFjdGlvbnNbMF0udHJpZ2dlcmVkID8gcmVzdWx0LnRvcFNjb3JpbmdJbnRlbnQuYWN0aW9uc1swXSA6IG51bGxcbiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcmVzdWx0LnRvcFNjb3JpbmdJbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAvLyBBUEkgdjEuMFxuXG4gICAgICAgICAgICAgICAgLy8gSW50ZW50cyBmb3IgdGhlIGJ1aWx0aW4gQ29ydGFuYSBhcHAgZG9uJ3QgcmV0dXJuIGEgc2NvcmUuXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5pbnRlbnRzLmxlbmd0aCA9PSAxICYmICFyZXN1bHQuaW50ZW50c1swXS5oYXNPd25Qcm9wZXJ0eSgnc2NvcmUnKSkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0LmludGVudHNbMF0uc2NvcmUgPSAxLjBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBGaW5kIHRvcCBpbnRlbnRcbiAgICAgICAgICAgICAgICAvLyAtIE9ubHkgcmV0dXJuIGVudGl0aWVzIGZvciB0aGUgbW9kZWwgd2l0aCB0aGUgdG9wIGludGVudC5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5pbnRlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBpbnRlbnQgPSByZXN1bHQuaW50ZW50c1tpXVxuICAgICAgICAgICAgICAgICAgaWYgKGludGVudC5zY29yZSA+IG1pblRocmVzaG9sZCAmJlxuICAgICAgICAgICAgICAgICAgICAoIW1lc3NhZ2UudG9wSW50ZW50IHx8IGludGVudC5zY29yZSA+IG1lc3NhZ2UudG9wSW50ZW50LnNjb3JlKSkge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnRvcEludGVudCA9IGludGVudFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmVudGl0aWVzID0gcmVzdWx0LmVudGl0aWVzIHx8IFtdXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuYWN0aW9uID0gaW50ZW50LmFjdGlvbnMgJiYgaW50ZW50LmFjdGlvbnNbMF0udHJpZ2dlcmVkID8gaW50ZW50LmFjdGlvbnNbMF0gOiBudWxsXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVyci50b1N0cmluZygpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZS50b1N0cmluZygpKVxuICAgICAgICAgIH1cbiAgICAgICAgICBuZXh0KClcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHQoKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGhlYXJJbnRlbnQodGVzdHMsIHsgdG9wSW50ZW50IH0pIHtcbiAgICBpZiAodG9wSW50ZW50KSB7XG4gICAgICBjb25zdCBpbnRlbnQgPSB0b3BJbnRlbnQuaW50ZW50LnRvTG93ZXJDYXNlKClcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVzdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKHRlc3RzW2ldLnRyaW0oKS50b0xvd2VyQ2FzZSgpID09IGludGVudCkge1xuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cbiJdfQ==