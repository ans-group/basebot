"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;var _request = _interopRequireDefault(require("request"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}var _default =

function _default(_ref) {var logger = _ref.logger;
  var error = logger('middleware:luis', 'error');
  if (!process.env.LUIS_URI) {
    error('LUIS_URI must be set');
  }

  return { receive: receive, hear: hear, triggers: ['intent'] };

  function receive() {
    var serviceUri = process.env.LUIS_URI.trim();
    if (serviceUri.lastIndexOf('&q=') != serviceUri.length - 3) {
      serviceUri += '&q=';
    }
    var minThreshold = process.env.LUIS_MIN_THRESHOLD || 0.1;
    var captureThreshold = process.env.LUIS_CAPTURE_THRESHOLD || 0.7;
    return function (bot, message, next) {
      // We will only process the text and either there's no topIntent
      // or the score for the topIntent is below the captureThreshold.
      if (message.text && (
      !message.topIntent || message.topIntent.score < captureThreshold)) {
        var uri = serviceUri + encodeURIComponent(message.text);
        _request["default"].get(uri, function (err, res, body) {
          try {
            if (!err) {
              var result = JSON.parse(body);

              if (result.topScoringIntent && result.topScoringIntent.intent !== 'None') {
                // API v2.0
                message.topIntent = result.topScoringIntent;
                message.entities = result.entities || [];
                message.action = result.topScoringIntent.actions && result.topScoringIntent.actions[0].triggered ? result.topScoringIntent.actions[0] : null;
              } else if (!result.topScoringIntent) {
                // API v1.0

                // Intents for the builtin Cortana app don't return a score.
                if (result.intents.length == 1 && !result.intents[0].hasOwnProperty('score')) {
                  result.intents[0].score = 1.0;
                }

                // Find top intent
                // - Only return entities for the model with the top intent.
                for (var i = 0; i < result.intents.length; i++) {
                  var intent = result.intents[i];
                  if (intent.score > minThreshold && (
                  !message.topIntent || intent.score > message.topIntent.score)) {
                    message.topIntent = intent;
                    message.entities = result.entities || [];
                    message.action = intent.actions && intent.actions[0].triggered ? intent.actions[0] : null;
                  }
                }
              }
            } else {
              console.error(err.toString());
            }
          } catch (e) {
            console.error(e.toString());
          }
          next();
        });
      } else {
        next();
      }
    };
  }

  function hear(tests, _ref2) {var topIntent = _ref2.topIntent;
    var captureThreshold = process.env.LUIS_CAPTURE_THRESHOLD || 0.7;
    if (topIntent && topIntent.score >= captureThreshold) {
      var intent = topIntent.intent.toLowerCase();
      for (var i = 0; i < tests.length; i++) {
        if (tests[i].trim().toLowerCase() == intent) {
          return true;
        }
      }
    }
    return false;
  }
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImVycm9yIiwicHJvY2VzcyIsImVudiIsIkxVSVNfVVJJIiwicmVjZWl2ZSIsImhlYXIiLCJ0cmlnZ2VycyIsInNlcnZpY2VVcmkiLCJ0cmltIiwibGFzdEluZGV4T2YiLCJsZW5ndGgiLCJtaW5UaHJlc2hvbGQiLCJMVUlTX01JTl9USFJFU0hPTEQiLCJjYXB0dXJlVGhyZXNob2xkIiwiTFVJU19DQVBUVVJFX1RIUkVTSE9MRCIsImJvdCIsIm1lc3NhZ2UiLCJuZXh0IiwidGV4dCIsInRvcEludGVudCIsInNjb3JlIiwidXJpIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwicmVxdWVzdCIsImdldCIsImVyciIsInJlcyIsImJvZHkiLCJyZXN1bHQiLCJKU09OIiwicGFyc2UiLCJ0b3BTY29yaW5nSW50ZW50IiwiaW50ZW50IiwiZW50aXRpZXMiLCJhY3Rpb24iLCJhY3Rpb25zIiwidHJpZ2dlcmVkIiwiaW50ZW50cyIsImhhc093blByb3BlcnR5IiwiaSIsImNvbnNvbGUiLCJ0b1N0cmluZyIsImUiLCJ0ZXN0cyIsInRvTG93ZXJDYXNlIl0sIm1hcHBpbmdzIjoidUdBQUEsMEQ7O0FBRWUsd0JBQWdCLEtBQWJBLE1BQWEsUUFBYkEsTUFBYTtBQUM3QixNQUFNQyxLQUFLLEdBQUdELE1BQU0sQ0FBQyxpQkFBRCxFQUFvQixPQUFwQixDQUFwQjtBQUNBLE1BQUksQ0FBQ0UsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQWpCLEVBQTJCO0FBQ3pCSCxJQUFBQSxLQUFLLENBQUMsc0JBQUQsQ0FBTDtBQUNEOztBQUVELFNBQU8sRUFBRUksT0FBTyxFQUFQQSxPQUFGLEVBQVdDLElBQUksRUFBSkEsSUFBWCxFQUFpQkMsUUFBUSxFQUFFLENBQUMsUUFBRCxDQUEzQixFQUFQOztBQUVBLFdBQVNGLE9BQVQsR0FBbUI7QUFDakIsUUFBSUcsVUFBVSxHQUFHTixPQUFPLENBQUNDLEdBQVIsQ0FBWUMsUUFBWixDQUFx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cG9ydCBkZWZhdWx0ICh7IGxvZ2dlciB9KSA9PiB7XG4gIGNvbnN0IGVycm9yID0gbG9nZ2VyKCdtaWRkbGV3YXJlOmx1aXMnLCAnZXJyb3InKVxuICBpZiAoIXByb2Nlc3MuZW52LkxVSVNfVVJJKSB7XG4gICAgZXJyb3IoJ0xVSVNfVVJJIG11c3QgYmUgc2V0JylcbiAgfVxuXG4gIHJldHVybiB7IHJlY2VpdmUsIGhlYXIsIHRyaWdnZXJzOiBbJ2ludGVudCddIH1cblxuICBmdW5jdGlvbiByZWNlaXZlKCkge1xuICAgIHZhciBzZXJ2aWNlVXJpID0gcHJvY2Vzcy5lbnYuTFVJU19VUkkudHJpbSgpXG4gICAgaWYgKHNlcnZpY2VVcmkubGFzdEluZGV4T2YoJyZxPScpICE9IHNlcnZpY2VVcmkubGVuZ3RoIC0gMykge1xuICAgICAgc2VydmljZVVyaSArPSAnJnE9J1xuICAgIH1cbiAgICBjb25zdCBtaW5UaHJlc2hvbGQgPSBwcm9jZXNzLmVudi5MVUlTX01JTl9USFJFU0hPTEQgfHwgMC4xXG4gICAgY29uc3QgY2FwdHVyZVRocmVzaG9sZCA9IHByb2Nlc3MuZW52LkxVSVNfQ0FQVFVSRV9USFJFU0hPTEQgfHwgMC43XG4gICAgcmV0dXJuIChib3QsIG1lc3NhZ2UsIG5leHQpID0+IHtcbiAgICAgIC8vIFdlIHdpbGwgb25seSBwcm9jZXNzIHRoZSB0ZXh0IGFuZCBlaXRoZXIgdGhlcmUncyBubyB0b3BJbnRlbnRcbiAgICAgIC8vIG9yIHRoZSBzY29yZSBmb3IgdGhlIHRvcEludGVudCBpcyBiZWxvdyB0aGUgY2FwdHVyZVRocmVzaG9sZC5cbiAgICAgIGlmIChtZXNzYWdlLnRleHQgJiZcbiAgICAgICAgKCFtZXNzYWdlLnRvcEludGVudCB8fCBtZXNzYWdlLnRvcEludGVudC5zY29yZSA8IGNhcHR1cmVUaHJlc2hvbGQpKSB7XG4gICAgICAgIGNvbnN0IHVyaSA9IHNlcnZpY2VVcmkgKyBlbmNvZGVVUklDb21wb25lbnQobWVzc2FnZS50ZXh0KVxuICAgICAgICByZXF1ZXN0LmdldCh1cmksIChlcnIsIHJlcywgYm9keSkgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBKU09OLnBhcnNlKGJvZHkpXG5cbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC50b3BTY29yaW5nSW50ZW50ICYmIHJlc3VsdC50b3BTY29yaW5nSW50ZW50LmludGVudCAhPT0gJ05vbmUnKSB7XG4gICAgICAgICAgICAgICAgLy8gQVBJIHYyLjBcbiAgICAgICAgICAgICAgICBtZXNzYWdlLnRvcEludGVudCA9IHJlc3VsdC50b3BTY29yaW5nSW50ZW50XG4gICAgICAgICAgICAgICAgbWVzc2FnZS5lbnRpdGllcyA9IHJlc3VsdC5lbnRpdGllcyB8fCBbXVxuICAgICAgICAgICAgICAgIG1lc3NhZ2UuYWN0aW9uID0gcmVzdWx0LnRvcFNjb3JpbmdJbnRlbnQuYWN0aW9ucyAmJiByZXN1bHQudG9wU2NvcmluZ0ludGVudC5hY3Rpb25zWzBdLnRyaWdnZXJlZCA/IHJlc3VsdC50b3BTY29yaW5nSW50ZW50LmFjdGlvbnNbMF0gOiBudWxsXG4gICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXJlc3VsdC50b3BTY29yaW5nSW50ZW50KSB7XG4gICAgICAgICAgICAgICAgLy8gQVBJIHYxLjBcblxuICAgICAgICAgICAgICAgIC8vIEludGVudHMgZm9yIHRoZSBidWlsdGluIENvcnRhbmEgYXBwIGRvbid0IHJldHVybiBhIHNjb3JlLlxuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuaW50ZW50cy5sZW5ndGggPT0gMSAmJiAhcmVzdWx0LmludGVudHNbMF0uaGFzT3duUHJvcGVydHkoJ3Njb3JlJykpIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdC5pbnRlbnRzWzBdLnNjb3JlID0gMS4wXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gRmluZCB0b3AgaW50ZW50XG4gICAgICAgICAgICAgICAgLy8gLSBPbmx5IHJldHVybiBlbnRpdGllcyBmb3IgdGhlIG1vZGVsIHdpdGggdGhlIHRvcCBpbnRlbnQuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQuaW50ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZW50ID0gcmVzdWx0LmludGVudHNbaV1cbiAgICAgICAgICAgICAgICAgIGlmIChpbnRlbnQuc2NvcmUgPiBtaW5UaHJlc2hvbGQgJiZcbiAgICAgICAgICAgICAgICAgICAgKCFtZXNzYWdlLnRvcEludGVudCB8fCBpbnRlbnQuc2NvcmUgPiBtZXNzYWdlLnRvcEludGVudC5zY29yZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50b3BJbnRlbnQgPSBpbnRlbnRcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5lbnRpdGllcyA9IHJlc3VsdC5lbnRpdGllcyB8fCBbXVxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmFjdGlvbiA9IGludGVudC5hY3Rpb25zICYmIGludGVudC5hY3Rpb25zWzBdLnRyaWdnZXJlZCA/IGludGVudC5hY3Rpb25zWzBdIDogbnVsbFxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIudG9TdHJpbmcoKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUudG9TdHJpbmcoKSlcbiAgICAgICAgICB9XG4gICAgICAgICAgbmV4dCgpXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXh0KClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBoZWFyKHRlc3RzLCB7IHRvcEludGVudCB9KSB7XG4gICAgY29uc3QgY2FwdHVyZVRocmVzaG9sZCA9IHByb2Nlc3MuZW52LkxVSVNfQ0FQVFVSRV9USFJFU0hPTEQgfHwgMC43XG4gICAgaWYgKHRvcEludGVudCAmJiB0b3BJbnRlbnQuc2NvcmUgPj0gY2FwdHVyZVRocmVzaG9sZCkge1xuICAgICAgY29uc3QgaW50ZW50ID0gdG9wSW50ZW50LmludGVudC50b0xvd2VyQ2FzZSgpXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRlc3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmICh0ZXN0c1tpXS50cmltKCkudG9Mb3dlckNhc2UoKSA9PSBpbnRlbnQpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZVxuICB9XG59XG4iXX0=