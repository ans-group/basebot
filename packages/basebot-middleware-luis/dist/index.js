"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;var _request = _interopRequireDefault(require("request"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}var _default =

function _default(logger) {
  if (!process.env.LUIS_URI) throw new Error('LUIS_URI must be set');

  return { receive: receive, hearIntent: hearIntent };

  function receive() {
    serviceUri = process.env.LUIS_URI.trim();
    if (serviceUri.lastIndexOf('&q=') != serviceUri.length - 3) {
      serviceUri += '&q=';
    }
    var minThreshold = process.env.LUIS_MIN_THRESHOLD || 0.1;
    var captureThreshold = process.env.LUIS_CAPTURE_THRESHOLD || 0.7;
    return function (bot, message, next) {
      // We will only process the text and either there's no topIntent
      // or the score for the topIntent is below the captureThreshold.
      if (message.text && (
      !message.topIntent || message.topIntent.score < captureThreshold)) {
        var uri = serviceUri + encodeURIComponent(message.text);
        _request["default"].get(uri, function (err, res, body) {
          try {
            if (!err) {
              var result = JSON.parse(body);

              if (result.topScoringIntent) {
                // API v2.0
                message.topIntent = result.topScoringIntent;
                message.entities = result.entities || [];
                message.action = result.topScoringIntent.actions && result.topScoringIntent.actions[0].triggered ? result.topScoringIntent.actions[0] : null;
              } else {
                // API v1.0

                // Intents for the builtin Cortana app don't return a score.
                if (result.intents.length == 1 && !result.intents[0].hasOwnProperty('score')) {
                  result.intents[0].score = 1.0;
                }

                // Find top intent
                // - Only return entities for the model with the top intent.
                for (var i = 0; i < result.intents.length; i++) {
                  var intent = result.intents[i];
                  if (intent.score > minThreshold && (
                  !message.topIntent || intent.score > message.topIntent.score)) {
                    message.topIntent = intent;
                    message.entities = result.entities || [];
                    message.action = intent.actions && intent.actions[0].triggered ? intent.actions[0] : null;
                  }
                }
              }
            } else {
              console.error(err.toString());
            }
          } catch (e) {
            console.error(e.toString());
          }
          next();
        });
      } else {
        next();
      }
    };
  }

  function hearIntent(tests, _ref) {var topIntent = _ref.topIntent;
    if (topIntent) {
      var intent = topIntent.intent.toLowerCase();
      for (var i = 0; i < tests.length; i++) {
        if (tests[i].trim().toLowerCase() == intent) {
          return true;
        }
      }
    }
    return false;
  }
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsInByb2Nlc3MiLCJlbnYiLCJMVUlTX1VSSSIsIkVycm9yIiwicmVjZWl2ZSIsImhlYXJJbnRlbnQiLCJzZXJ2aWNlVXJpIiwidHJpbSIsImxhc3RJbmRleE9mIiwibGVuZ3RoIiwibWluVGhyZXNob2xkIiwiTFVJU19NSU5fVEhSRVNIT0xEIiwiY2FwdHVyZVRocmVzaG9sZCIsIkxVSVNfQ0FQVFVSRV9USFJFU0hPTEQiLCJib3QiLCJtZXNzYWdlIiwibmV4dCIsInRleHQiLCJ0b3BJbnRlbnQiLCJzY29yZSIsInVyaSIsImVuY29kZVVSSUNvbXBvbmVudCIsInJlcXVlc3QiLCJnZXQiLCJlcnIiLCJyZXMiLCJib2R5IiwicmVzdWx0IiwiSlNPTiIsInBhcnNlIiwidG9wU2NvcmluZ0ludGVudCIsImVudGl0aWVzIiwiYWN0aW9uIiwiYWN0aW9ucyIsInRyaWdnZXJlZCIsImludGVudHMiLCJoYXNPd25Qcm9wZXJ0eSIsImkiLCJpbnRlbnQiLCJjb25zb2xlIiwiZXJyb3IiLCJ0b1N0cmluZyIsImUiLCJ0ZXN0cyIsInRvTG93ZXJDYXNlIl0sIm1hcHBpbmdzIjoidUdBQUEsMEQ7O0FBRWUsa0JBQUNBLE1BQUQsRUFBWTtBQUN6QixNQUFJLENBQUNDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFqQixFQUEyQixNQUFNLElBQUlDLEtBQUosQ0FBVSxzQkFBVixDQUFOOztBQUUzQixTQUFPLEVBQUNDLE9BQU8sRUFBUEEsT0FBRCxFQUFTQyxVQUFVLEVBQVZBLFVBQVQsRUFBUDs7QUFFQSxXQUFTRCxPQUFULEdBQW9CO0FBQ2xCRSxJQUFBQSxVQUFVLEdBQUdOLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFaLENBQXFCSyxJQUFyQixFQUFiO0FBQ0EsUUFBSUQsVUFBVSxDQUFDRSxXQUFYLENBQXVCLEtBQXZCLEtBQWlDRixVQUFVLENBQUNHLE1BQVgsR0FBb0IsQ0FBekQsRUFBNEQ7QUFDMURILE1B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RUFBZDtBQUNEO0FBQ0YsV0FoQ0QsQ0FnQ0UsT0FBT0MsQ0FBUCxFQUFVO0FBQ1ZILFlBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjRSxDQUFDLENBQUNELFFBQUYsRUFBZDtBQUNEO0FBQ0R6QixVQUFBQSxJQUFJO0FBQ0wsU0FyQ0Q7QUFzQ0QsT0F6Q0QsTUF5Q087QUFDTEEsUUFBQUEsSUFBSTtBQUNMO0FBQ0YsS0EvQ0Q7QUFnREQ7O0FBRUQsV0FBU1gsVUFBVCxDQUFxQnNDLEtBQXJCLFFBQTJDLEtBQWJ6QixTQUFhLFFBQWJBLFNBQWE7QUFDekMsUUFBSUEsU0FBSixFQUFlO0FBQ2IsVUFBTW9CLE1BQU0sR0FBR3BCLFNBQVMsQ0FBQ29CLE1BQVYsQ0FBaUJNLFdBQWpCLEVBQWY7QUFDQSxXQUFLLElBQUlQLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdNLEtBQUssQ0FBQ2xDLE1BQTFCLEVBQWtDNEIsQ0FBQyxFQUFuQyxFQUF1QztBQUNyQyxZQUFJTSxLQUFLLENBQUNOLENBQUQsQ0FBTCxDQUFTOUIsSUFBVCxHQUFnQnFDLFdBQWhCLE1BQWlDTixNQUFyQyxFQUE2QztBQUMzQyxpQkFBTyxJQUFQO0FBQ0Q7QUFDRjtBQUNGO0FBQ0QsV0FBTyxLQUFQO0FBQ0Q7QUFDRixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdCdcblxuZXhwb3J0IGRlZmF1bHQgKGxvZ2dlcikgPT4ge1xuICBpZiAoIXByb2Nlc3MuZW52LkxVSVNfVVJJKSB0aHJvdyBuZXcgRXJyb3IoJ0xVSVNfVVJJIG11c3QgYmUgc2V0JylcblxuICByZXR1cm4ge3JlY2VpdmUsaGVhckludGVudH1cblxuICBmdW5jdGlvbiByZWNlaXZlICgpIHtcbiAgICBzZXJ2aWNlVXJpID0gcHJvY2Vzcy5lbnYuTFVJU19VUkkudHJpbSgpXG4gICAgaWYgKHNlcnZpY2VVcmkubGFzdEluZGV4T2YoJyZxPScpICE9IHNlcnZpY2VVcmkubGVuZ3RoIC0gMykge1xuICAgICAgc2VydmljZVVyaSArPSAnJnE9J1xuICAgIH1cbiAgICBjb25zdCBtaW5UaHJlc2hvbGQgPSBwcm9jZXNzLmVudi5MVUlTX01JTl9USFJFU0hPTEQgfHwgMC4xXG4gICAgY29uc3QgY2FwdHVyZVRocmVzaG9sZCA9IHByb2Nlc3MuZW52LkxVSVNfQ0FQVFVSRV9USFJFU0hPTEQgfHwgMC43XG4gICAgcmV0dXJuIChib3QsIG1lc3NhZ2UsIG5leHQpID0+IHtcbiAgICAgIC8vIFdlIHdpbGwgb25seSBwcm9jZXNzIHRoZSB0ZXh0IGFuZCBlaXRoZXIgdGhlcmUncyBubyB0b3BJbnRlbnRcbiAgICAgIC8vIG9yIHRoZSBzY29yZSBmb3IgdGhlIHRvcEludGVudCBpcyBiZWxvdyB0aGUgY2FwdHVyZVRocmVzaG9sZC5cbiAgICAgIGlmIChtZXNzYWdlLnRleHQgJiZcbiAgICAgICAgKCFtZXNzYWdlLnRvcEludGVudCB8fCBtZXNzYWdlLnRvcEludGVudC5zY29yZSA8IGNhcHR1cmVUaHJlc2hvbGQpKSB7XG4gICAgICAgIGNvbnN0IHVyaSA9IHNlcnZpY2VVcmkgKyBlbmNvZGVVUklDb21wb25lbnQobWVzc2FnZS50ZXh0KVxuICAgICAgICByZXF1ZXN0LmdldCh1cmksIChlcnIsIHJlcywgYm9keSkgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBKU09OLnBhcnNlKGJvZHkpXG5cbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC50b3BTY29yaW5nSW50ZW50KSB7XG4gICAgICAgICAgICAgICAgLy8gQVBJIHYyLjBcbiAgICAgICAgICAgICAgICBtZXNzYWdlLnRvcEludGVudCA9IHJlc3VsdC50b3BTY29yaW5nSW50ZW50XG4gICAgICAgICAgICAgICAgbWVzc2FnZS5lbnRpdGllcyA9IHJlc3VsdC5lbnRpdGllcyB8fCBbXVxuICAgICAgICAgICAgICAgIG1lc3NhZ2UuYWN0aW9uID0gcmVzdWx0LnRvcFNjb3JpbmdJbnRlbnQuYWN0aW9ucyAmJiByZXN1bHQudG9wU2NvcmluZ0ludGVudC5hY3Rpb25zWzBdLnRyaWdnZXJlZCA/IHJlc3VsdC50b3BTY29yaW5nSW50ZW50LmFjdGlvbnNbMF0gOiBudWxsXG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gQVBJIHYxLjBcblxuICAgICAgICAgICAgICAgIC8vIEludGVudHMgZm9yIHRoZSBidWlsdGluIENvcnRhbmEgYXBwIGRvbid0IHJldHVybiBhIHNjb3JlLlxuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuaW50ZW50cy5sZW5ndGggPT0gMSAmJiAhcmVzdWx0LmludGVudHNbMF0uaGFzT3duUHJvcGVydHkoJ3Njb3JlJykpIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdC5pbnRlbnRzWzBdLnNjb3JlID0gMS4wXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gRmluZCB0b3AgaW50ZW50XG4gICAgICAgICAgICAgICAgLy8gLSBPbmx5IHJldHVybiBlbnRpdGllcyBmb3IgdGhlIG1vZGVsIHdpdGggdGhlIHRvcCBpbnRlbnQuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQuaW50ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZW50ID0gcmVzdWx0LmludGVudHNbaV1cbiAgICAgICAgICAgICAgICAgIGlmIChpbnRlbnQuc2NvcmUgPiBtaW5UaHJlc2hvbGQgJiZcbiAgICAgICAgICAgICAgICAgICAgKCFtZXNzYWdlLnRvcEludGVudCB8fCBpbnRlbnQuc2NvcmUgPiBtZXNzYWdlLnRvcEludGVudC5zY29yZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50b3BJbnRlbnQgPSBpbnRlbnRcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5lbnRpdGllcyA9IHJlc3VsdC5lbnRpdGllcyB8fCBbXVxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmFjdGlvbiA9IGludGVudC5hY3Rpb25zICYmIGludGVudC5hY3Rpb25zWzBdLnRyaWdnZXJlZCA/IGludGVudC5hY3Rpb25zWzBdIDogbnVsbFxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIudG9TdHJpbmcoKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUudG9TdHJpbmcoKSlcbiAgICAgICAgICB9XG4gICAgICAgICAgbmV4dCgpXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXh0KClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBoZWFySW50ZW50ICh0ZXN0cywgeyB0b3BJbnRlbnQgfSkge1xuICAgIGlmICh0b3BJbnRlbnQpIHtcbiAgICAgIGNvbnN0IGludGVudCA9IHRvcEludGVudC5pbnRlbnQudG9Mb3dlckNhc2UoKVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZXN0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAodGVzdHNbaV0udHJpbSgpLnRvTG93ZXJDYXNlKCkgPT0gaW50ZW50KSB7XG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuIl19