"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;var _request = _interopRequireDefault(require("request"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}var _default =

function _default(logger) {
  var error = logger('middleware:luis', 'error');
  if (!process.env.LUIS_URI) {
    error('LUIS_URI must be set');
  }

  return { receive: receive, hearIntent: hearIntent };

  function receive() {
    var serviceUri = process.env.LUIS_URI.trim();
    if (serviceUri.lastIndexOf('&q=') != serviceUri.length - 3) {
      serviceUri += '&q=';
    }
    var minThreshold = process.env.LUIS_MIN_THRESHOLD || 0.1;
    var captureThreshold = process.env.LUIS_CAPTURE_THRESHOLD || 0.7;
    return function (bot, message, next) {
      // We will only process the text and either there's no topIntent
      // or the score for the topIntent is below the captureThreshold.
      if (message.text && (
      !message.topIntent || message.topIntent.score < captureThreshold)) {
        var uri = serviceUri + encodeURIComponent(message.text);
        _request["default"].get(uri, function (err, res, body) {
          try {
            if (!err) {
              var result = JSON.parse(body);

              if (result.topScoringIntent && result.topScoringIntent.intent !== 'None') {
                // API v2.0
                message.topIntent = result.topScoringIntent;
                message.entities = result.entities || [];
                message.action = result.topScoringIntent.actions && result.topScoringIntent.actions[0].triggered ? result.topScoringIntent.actions[0] : null;
              } else if (!result.topScoringIntent) {
                // API v1.0

                // Intents for the builtin Cortana app don't return a score.
                if (result.intents.length == 1 && !result.intents[0].hasOwnProperty('score')) {
                  result.intents[0].score = 1.0;
                }

                // Find top intent
                // - Only return entities for the model with the top intent.
                for (var i = 0; i < result.intents.length; i++) {
                  var intent = result.intents[i];
                  if (intent.score > minThreshold && (
                  !message.topIntent || intent.score > message.topIntent.score)) {
                    message.topIntent = intent;
                    message.entities = result.entities || [];
                    message.action = intent.actions && intent.actions[0].triggered ? intent.actions[0] : null;
                  }
                }
              }
            } else {
              console.error(err.toString());
            }
          } catch (e) {
            console.error(e.toString());
          }
          next();
        });
      } else {
        next();
      }
    };
  }

  function hearIntent(tests, _ref) {var topIntent = _ref.topIntent;
    var captureThreshold = process.env.LUIS_CAPTURE_THRESHOLD || 0.7;
    if (topIntent && topIntent.score >= captureThreshold) {
      var intent = topIntent.intent.toLowerCase();
      for (var i = 0; i < tests.length; i++) {
        if (tests[i].trim().toLowerCase() == intent) {
          return true;
        }
      }
    }
    return false;
  }
};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImVycm9yIiwicHJvY2VzcyIsImVudiIsIkxVSVNfVVJJIiwicmVjZWl2ZSIsImhlYXJJbnRlbnQiLCJzZXJ2aWNlVXJpIiwidHJpbSIsImxhc3RJbmRleE9mIiwibGVuZ3RoIiwibWluVGhyZXNob2xkIiwiTFVJU19NSU5fVEhSRVNIT0xEIiwiY2FwdHVyZVRocmVzaG9sZCIsIkxVSVNfQ0FQVFVSRV9USFJFU0hPTEQiLCJib3QiLCJtZXNzYWdlIiwibmV4dCIsInRleHQiLCJ0b3BJbnRlbnQiLCJzY29yZSIsInVyaSIsImVuY29kZVVSSUNvbXBvbmVudCIsInJlcXVlc3QiLCJnZXQiLCJlcnIiLCJyZXMiLCJib2R5IiwicmVzdWx0IiwiSlNPTiIsInBhcnNlIiwidG9wU2NvcmluZ0ludGVudCIsImludGVudCIsImVudGl0aWVzIiwiYWN0aW9uIiwiYWN0aW9ucyIsInRyaWdnZXJlZCIsImludGVudHMiLCJoYXNPd25Qcm9wZXJ0eSIsImkiLCJjb25zb2xlIiwidG9TdHJpbmciLCJlIiwidGVzdHMiLCJ0b0xvd2VyQ2FzZSJdLCJtYXBwaW5ncyI6InVHQUFBLDBEOztBQUVlLGtCQUFDQSxNQUFELEVBQVk7QUFDekIsTUFBTUMsS0FBSyxHQUFHRCxNQUFNLENBQUMsaUJBQUQsRUFBb0IsT0FBcEIsQ0FBcEI7QUFDQSxNQUFJLENBQUNFLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFqQixFQUEyQjtBQUN6QkgsSUFBQUEsS0FBSyxDQUFDLHNCQUFELENBQUw7QUFDRDs7QUFFRCxTQUFPLEVBQUVJLE9BQU8sRUFBUEEsT0FBRixFQUFXQyxVQUFVLEVBQVZBLFVBQVgsRUFBUDs7QUFFQSxXQUFTRCxPQUFULEdBQW1CO0FBQ2pCLFFBQUlFLFVBQVUsR0FBR0wsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQVosQ0FBcUJJLElBQXJCLEVBQWpCO0FBQ0EsUUFBSUQsVUFBVSxDQUFDRSxXQUFYLENBQXVCLEtB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R0FBZ0RKLE1BQU0sQ0FBQ0csT0FBUCxDQUFlLENBQWYsQ0FBaEQsR0FBb0UsSUFBckY7QUFDRDtBQUNGO0FBQ0Y7QUFDRixhQTVCRCxNQTRCTztBQUNMSyxjQUFBQSxPQUFPLENBQUN2QyxLQUFSLENBQWN3QixHQUFHLENBQUNnQixRQUFKLEVBQWQ7QUFDRDtBQUNGLFdBaENELENBZ0NFLE9BQU9DLENBQVAsRUFBVTtBQUNWRixZQUFBQSxPQUFPLENBQUN2QyxLQUFSLENBQWN5QyxDQUFDLENBQUNELFFBQUYsRUFBZDtBQUNEO0FBQ0R4QixVQUFBQSxJQUFJO0FBQ0wsU0FyQ0Q7QUFzQ0QsT0F6Q0QsTUF5Q087QUFDTEEsUUFBQUEsSUFBSTtBQUNMO0FBQ0YsS0EvQ0Q7QUFnREQ7O0FBRUQsV0FBU1gsVUFBVCxDQUFvQnFDLEtBQXBCLFFBQTBDLEtBQWJ4QixTQUFhLFFBQWJBLFNBQWE7QUFDeEMsUUFBTU4sZ0JBQWdCLEdBQUdYLE9BQU8sQ0FBQ0MsR0FBUixDQUFZVyxzQkFBWixJQUFzQyxHQUEvRDtBQUNBLFFBQUlLLFNBQVMsSUFBSUEsU0FBUyxDQUFDQyxLQUFWLElBQW1CUCxnQkFBcEMsRUFBc0Q7QUFDcEQsVUFBTW1CLE1BQU0sR0FBR2IsU0FBUyxDQUFDYSxNQUFWLENBQWlCWSxXQUFqQixFQUFmO0FBQ0EsV0FBSyxJQUFJTCxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHSSxLQUFLLENBQUNqQyxNQUExQixFQUFrQzZCLENBQUMsRUFBbkMsRUFBdUM7QUFDckMsWUFBSUksS0FBSyxDQUFDSixDQUFELENBQUwsQ0FBUy9CLElBQVQsR0FBZ0JvQyxXQUFoQixNQUFpQ1osTUFBckMsRUFBNkM7QUFDM0MsaUJBQU8sSUFBUDtBQUNEO0FBQ0Y7QUFDRjtBQUNELFdBQU8sS0FBUDtBQUNEO0FBQ0YsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QnXG5cbmV4cG9ydCBkZWZhdWx0IChsb2dnZXIpID0+IHtcbiAgY29uc3QgZXJyb3IgPSBsb2dnZXIoJ21pZGRsZXdhcmU6bHVpcycsICdlcnJvcicpXG4gIGlmICghcHJvY2Vzcy5lbnYuTFVJU19VUkkpIHtcbiAgICBlcnJvcignTFVJU19VUkkgbXVzdCBiZSBzZXQnKVxuICB9XG5cbiAgcmV0dXJuIHsgcmVjZWl2ZSwgaGVhckludGVudCB9XG5cbiAgZnVuY3Rpb24gcmVjZWl2ZSgpIHtcbiAgICB2YXIgc2VydmljZVVyaSA9IHByb2Nlc3MuZW52LkxVSVNfVVJJLnRyaW0oKVxuICAgIGlmIChzZXJ2aWNlVXJpLmxhc3RJbmRleE9mKCcmcT0nKSAhPSBzZXJ2aWNlVXJpLmxlbmd0aCAtIDMpIHtcbiAgICAgIHNlcnZpY2VVcmkgKz0gJyZxPSdcbiAgICB9XG4gICAgY29uc3QgbWluVGhyZXNob2xkID0gcHJvY2Vzcy5lbnYuTFVJU19NSU5fVEhSRVNIT0xEIHx8IDAuMVxuICAgIGNvbnN0IGNhcHR1cmVUaHJlc2hvbGQgPSBwcm9jZXNzLmVudi5MVUlTX0NBUFRVUkVfVEhSRVNIT0xEIHx8IDAuN1xuICAgIHJldHVybiAoYm90LCBtZXNzYWdlLCBuZXh0KSA9PiB7XG4gICAgICAvLyBXZSB3aWxsIG9ubHkgcHJvY2VzcyB0aGUgdGV4dCBhbmQgZWl0aGVyIHRoZXJlJ3Mgbm8gdG9wSW50ZW50XG4gICAgICAvLyBvciB0aGUgc2NvcmUgZm9yIHRoZSB0b3BJbnRlbnQgaXMgYmVsb3cgdGhlIGNhcHR1cmVUaHJlc2hvbGQuXG4gICAgICBpZiAobWVzc2FnZS50ZXh0ICYmXG4gICAgICAgICghbWVzc2FnZS50b3BJbnRlbnQgfHwgbWVzc2FnZS50b3BJbnRlbnQuc2NvcmUgPCBjYXB0dXJlVGhyZXNob2xkKSkge1xuICAgICAgICBjb25zdCB1cmkgPSBzZXJ2aWNlVXJpICsgZW5jb2RlVVJJQ29tcG9uZW50KG1lc3NhZ2UudGV4dClcbiAgICAgICAgcmVxdWVzdC5nZXQodXJpLCAoZXJyLCByZXMsIGJvZHkpID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gSlNPTi5wYXJzZShib2R5KVxuXG4gICAgICAgICAgICAgIGlmIChyZXN1bHQudG9wU2NvcmluZ0ludGVudCAmJiByZXN1bHQudG9wU2NvcmluZ0ludGVudC5pbnRlbnQgIT09ICdOb25lJykge1xuICAgICAgICAgICAgICAgIC8vIEFQSSB2Mi4wXG4gICAgICAgICAgICAgICAgbWVzc2FnZS50b3BJbnRlbnQgPSByZXN1bHQudG9wU2NvcmluZ0ludGVudFxuICAgICAgICAgICAgICAgIG1lc3NhZ2UuZW50aXRpZXMgPSByZXN1bHQuZW50aXRpZXMgfHwgW11cbiAgICAgICAgICAgICAgICBtZXNzYWdlLmFjdGlvbiA9IHJlc3VsdC50b3BTY29yaW5nSW50ZW50LmFjdGlvbnMgJiYgcmVzdWx0LnRvcFNjb3JpbmdJbnRlbnQuYWN0aW9uc1swXS50cmlnZ2VyZWQgPyByZXN1bHQudG9wU2NvcmluZ0ludGVudC5hY3Rpb25zWzBdIDogbnVsbFxuICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFyZXN1bHQudG9wU2NvcmluZ0ludGVudCkge1xuICAgICAgICAgICAgICAgIC8vIEFQSSB2MS4wXG5cbiAgICAgICAgICAgICAgICAvLyBJbnRlbnRzIGZvciB0aGUgYnVpbHRpbiBDb3J0YW5hIGFwcCBkb24ndCByZXR1cm4gYSBzY29yZS5cbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LmludGVudHMubGVuZ3RoID09IDEgJiYgIXJlc3VsdC5pbnRlbnRzWzBdLmhhc093blByb3BlcnR5KCdzY29yZScpKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQuaW50ZW50c1swXS5zY29yZSA9IDEuMFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIEZpbmQgdG9wIGludGVudFxuICAgICAgICAgICAgICAgIC8vIC0gT25seSByZXR1cm4gZW50aXRpZXMgZm9yIHRoZSBtb2RlbCB3aXRoIHRoZSB0b3AgaW50ZW50LlxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0LmludGVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVudCA9IHJlc3VsdC5pbnRlbnRzW2ldXG4gICAgICAgICAgICAgICAgICBpZiAoaW50ZW50LnNjb3JlID4gbWluVGhyZXNob2xkICYmXG4gICAgICAgICAgICAgICAgICAgICghbWVzc2FnZS50b3BJbnRlbnQgfHwgaW50ZW50LnNjb3JlID4gbWVzc2FnZS50b3BJbnRlbnQuc2NvcmUpKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UudG9wSW50ZW50ID0gaW50ZW50XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuZW50aXRpZXMgPSByZXN1bHQuZW50aXRpZXMgfHwgW11cbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5hY3Rpb24gPSBpbnRlbnQuYWN0aW9ucyAmJiBpbnRlbnQuYWN0aW9uc1swXS50cmlnZ2VyZWQgPyBpbnRlbnQuYWN0aW9uc1swXSA6IG51bGxcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLnRvU3RyaW5nKCkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlLnRvU3RyaW5nKCkpXG4gICAgICAgICAgfVxuICAgICAgICAgIG5leHQoKVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dCgpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gaGVhckludGVudCh0ZXN0cywgeyB0b3BJbnRlbnQgfSkge1xuICAgIGNvbnN0IGNhcHR1cmVUaHJlc2hvbGQgPSBwcm9jZXNzLmVudi5MVUlTX0NBUFRVUkVfVEhSRVNIT0xEIHx8IDAuN1xuICAgIGlmICh0b3BJbnRlbnQgJiYgdG9wSW50ZW50LnNjb3JlID49IGNhcHR1cmVUaHJlc2hvbGQpIHtcbiAgICAgIGNvbnN0IGludGVudCA9IHRvcEludGVudC5pbnRlbnQudG9Mb3dlckNhc2UoKVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZXN0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAodGVzdHNbaV0udHJpbSgpLnRvTG93ZXJDYXNlKCkgPT0gaW50ZW50KSB7XG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuIl19