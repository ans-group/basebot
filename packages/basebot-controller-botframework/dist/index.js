"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;var Botkit = require('botkit/lib/CoreBot');
var builder = require('botbuilder');

function BotFrameworkBot(configuration) {
  // Create a core botkit bot
  var bf_botkit = Botkit(configuration || {});

  /*
                                                  * customize the bot definition, which will be used when new connections
                                                  * spawn!
                                                  */
  bf_botkit.defineBot(function (botkit, config) {
    var bot = {
      botkit: botkit,
      config: config || {},
      utterances: botkit.utterances };


    bot.send = function (message, cb) {
      function done(err) {
        if (cb) {
          cb(err);
        }
      }

      if (!message || !message.address) {
        if (cb) {
          cb(new Error('Outgoing message requires a valid address...'));
        }
        return;
      }

      // Copy message minus user & channel fields
      var bf_message = {};
      for (var key in message) {
        switch (key) {
          case 'user':
          case 'channel':
            // ignore
            break;
          default:
            bf_message[key] = message[key];
            break;}

      }
      if (!bf_message.type) {
        bf_message.type = 'message';
      }

      // Ensure the message address has a valid conversation id.
      if (!bf_message.address.conversation) {
        bot.connector.startConversation(bf_message.address, function (err, adr) {
          if (!err) {
            // Send message through connector
            bf_message.address = adr;
            bot.connector.send([bf_message], done);
          } else {
            done(err);
          }
        });
      } else {
        // Send message through connector
        bot.connector.send([bf_message], done);
      }
    };

    bot.reply = function (src, resp, cb) {
      var msg = {};

      if (typeof resp === 'string') {
        msg.text = resp;
      } else {
        msg = resp;
      }

      msg.user = src.user;
      msg.channel = src.channel;
      msg.address = src.address;
      msg.to = src.user;

      bot.say(msg, cb);
    };

    bot.findConversation = function (message, cb) {
      botkit.debug('CUSTOM FIND CONVO', message.user, message.channel);
      for (var t = 0; t < botkit.tasks.length; t++) {
        for (var c = 0; c < botkit.tasks[t].convos.length; c++) {
          if (
          botkit.tasks[t].convos[c].isActive() &&
          botkit.tasks[t].convos[c].source_message.user == message.user &&
          botkit.tasks[t].convos[c].source_message.channel == message.channel &&
          botkit.excludedEvents.indexOf(message.type) == -1 // this type of message should not be included
          ) {
              botkit.debug('FOUND EXISTING CONVO!');
              cb(botkit.tasks[t].convos[c]);
              return;
            }
        }
      }

      cb();
    };

    // Create connector
    bot.connector = new builder.ChatConnector(config);

    return bot;
  });

  bf_botkit.middleware.normalize.use(function (bot, message, next) {
    /*
                                                                         * Break out user & channel fields from event
                                                                         * - These fields are used as keys for tracking conversations and storage.
                                                                         * - Prefixing with channelId to ensure that users & channels for different
                                                                         *   platforms are unique.
                                                                         */

    var prefix = message.address.channelId + ':';
    message.user = prefix + message.address.user.id;
    message.channel = prefix + message.address.conversation.id;

    // MS supplies a type field that is 'message' for most messages, but we want it to be our more generic message_received event
    if (message.type == 'message') {
      message.type = 'message_received';
    }

    next();
  });

  bf_botkit.middleware.format.use(function (bot, message, platform_message, next) {
    // clone the incoming message
    for (var k in message) {
      platform_message[k] = message[k];
    }

    next();
  });

  // set up a web route for receiving outgoing webhooks and/or slash commands

  bf_botkit.createWebhookEndpoints = function (webserver, bot, cb) {
    // Listen for incoming events
    bf_botkit.log(
    '** Serving webhook endpoints for the Microsoft Bot Framework at: ' +
    'http://' + bf_botkit.config.hostname + ':' +
    bf_botkit.config.port + '/botframework/receive');
    webserver.post('/botframework/receive', bot.connector.listen());

    // Receive events from chat connector
    bot.connector.onEvent(function (events, done) {
      for (var i = 0; i < events.length; i++) {
        var bf_event = events[i];

        bf_botkit.ingest(bot, bf_event, null);
      }

      if (done) {
        done(null);
      }
    });

    if (cb) {
      cb();
    }

    bf_botkit.startTicking();

    return bf_botkit;
  };

  return bf_botkit;
}var _default =

function _default(_ref) {var storage = _ref.storage,logger = _ref.logger;
  var controller = BotFrameworkBot({ storage: storage });
  var info = logger('channels:botservice', 'info');
  var error = logger('channels:botservice', 'error');
  return {
    controller: controller,
    name: 'botservice',
    start: function start(_ref2) {var app = _ref2.app;
      if (!process.env.AZURE_APP_ID || !process.env.AZURE_APP_SECRET) {
        error('AZURE_APP_SECRET and AZURE_APP_ID are required env vars');
      }
      var bot = controller.spawn({
        appId: process.env.AZURE_APP_ID,
        appPassword: process.env.AZURE_APP_SECRET });

      controller.createWebhookEndpoints(app, bot);
      info('Azure bot listening');
    } };

};exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2luZGV4LmpzIl0sIm5hbWVzIjpbIkJvdGtpdCIsInJlcXVpcmUiLCJidWlsZGVyIiwiQm90RnJhbWV3b3JrQm90IiwiY29uZmlndXJhdGlvbiIsImJmX2JvdGtpdCIsImRlZmluZUJvdCIsImJvdGtpdCIsImNvbmZpZyIsImJvdCIsInV0dGVyYW5jZXMiLCJzZW5kIiwibWVzc2FnZSIsImNiIiwiZG9uZSIsImVyciIsImFkZHJlc3MiLCJFcnJvciIsImJmX21lc3NhZ2UiLCJrZXkiLCJ0eXBlIiwiY29udmVyc2F0aW9uIiwiY29ubmVjdG9yIiwic3RhcnRDb252ZXJzYXRpb24iLCJhZHIiLCJyZXBseSIsInNyYyIsInJlc3AiLCJtc2ciLCJ0ZXh0IiwidXNlciIsImNoYW5uZWwiLCJ0byIsInNheSIsImZpbmRDb252ZXJzYXRpb24iLCJkZWJ1ZyIsInQiLCJ0YXNrcyIsImxlbmd0aCIsImMiLCJjb252b3MiLCJpc0FjdGl2ZSIsInNvdXJjZV9tZXNzYWdlIiwiZXhjbHVkZWRFdmVudHMiLCJpbmRleE9mIiwiQ2hhdENvbm5lY3RvciIsIm1pZGRsZXdhcmUiLCJub3JtYWxpemUiLCJ1c2UiLCJuZXh0IiwicHJlZml4IiwiY2hhbm5lbElkIiwiaWQiLCJmb3JtYXQiLCJwbGF0Zm9ybV9tZXNzYWdlIiwiayIsImNyZWF0ZVdlYmhvb2tFbmRwb2ludHMiLCJ3ZWJzZXJ2ZXIiLCJsb2ciLCJob3N0bmFtZSIsInBvcnQiLCJwb3N0IiwibGlzdGVuIiwib25FdmVudCIsImV2ZW50cyIsImkiLCJiZl9ldmVudCIsImluZ2VzdCIsInN0YXJ0VGlja2luZyIsInN0b3JhZ2UiLCJsb2dnZXIiLCJjb250cm9sbGVyIiwiaW5mbyIsImVycm9yIiwibmFtZSIsInN0YXJ0IiwiYXBwIiwicHJvY2VzcyIsImVudiIsIkFaVVJFX0FQUF9JRCIsIkFaVVJFX0FQUF9TRUNSRVQiLCJzcGF3biIsImFwcElkIiwiYXBwUGFzc3dvcmQiXSwibWFwcGluZ3MiOiJ1R0FBQSxJQUFJ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LEtBYkksRUFBUDs7QUFlRCxDIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEJvdGtpdCA9IHJlcXVpcmUoJ2JvdGtpdC9saWIvQ29yZUJvdCcpXG52YXIgYnVpbGRlciA9IHJlcXVpcmUoJ2JvdGJ1aWxkZXInKVxuXG5mdW5jdGlvbiBCb3RGcmFtZXdvcmtCb3QoY29uZmlndXJhdGlvbikge1xuICAvLyBDcmVhdGUgYSBjb3JlIGJvdGtpdCBib3RcbiAgdmFyIGJmX2JvdGtpdCA9IEJvdGtpdChjb25maWd1cmF0aW9uIHx8IHt9KVxuXG4gIC8qXG4gICAgICogY3VzdG9taXplIHRoZSBib3QgZGVmaW5pdGlvbiwgd2hpY2ggd2lsbCBiZSB1c2VkIHdoZW4gbmV3IGNvbm5lY3Rpb25zXG4gICAgICogc3Bhd24hXG4gICAgICovXG4gIGJmX2JvdGtpdC5kZWZpbmVCb3QoZnVuY3Rpb24oYm90a2l0LCBjb25maWcpIHtcbiAgICB2YXIgYm90ID0ge1xuICAgICAgYm90a2l0OiBib3RraXQsXG4gICAgICBjb25maWc6IGNvbmZpZyB8fCB7fSxcbiAgICAgIHV0dGVyYW5jZXM6IGJvdGtpdC51dHRlcmFuY2VzXG4gICAgfVxuXG4gICAgYm90LnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlLCBjYikge1xuICAgICAgZnVuY3Rpb24gZG9uZShlcnIpIHtcbiAgICAgICAgaWYgKGNiKSB7XG4gICAgICAgICAgY2IoZXJyKVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICghbWVzc2FnZSB8fCAhbWVzc2FnZS5hZGRyZXNzKSB7XG4gICAgICAgIGlmIChjYikge1xuICAgICAgICAgIGNiKG5ldyBFcnJvcignT3V0Z29pbmcgbWVzc2FnZSByZXF1aXJlcyBhIHZhbGlkIGFkZHJlc3MuLi4nKSlcbiAgICAgICAgfVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgLy8gQ29weSBtZXNzYWdlIG1pbnVzIHVzZXIgJiBjaGFubmVsIGZpZWxkc1xuICAgICAgdmFyIGJmX21lc3NhZ2UgPSB7fVxuICAgICAgZm9yICh2YXIga2V5IGluIG1lc3NhZ2UpIHtcbiAgICAgICAgc3dpdGNoIChrZXkpIHtcbiAgICAgICAgY2FzZSAndXNlcic6XG4gICAgICAgIGNhc2UgJ2NoYW5uZWwnOlxuICAgICAgICAgIC8vIGlnbm9yZVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgYmZfbWVzc2FnZVtrZXldID0gbWVzc2FnZVtrZXldXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFiZl9tZXNzYWdlLnR5cGUpIHtcbiAgICAgICAgYmZfbWVzc2FnZS50eXBlID0gJ21lc3NhZ2UnXG4gICAgICB9XG5cbiAgICAgIC8vIEVuc3VyZSB0aGUgbWVzc2FnZSBhZGRyZXNzIGhhcyBhIHZhbGlkIGNvbnZlcnNhdGlvbiBpZC5cbiAgICAgIGlmICghYmZfbWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvbikge1xuICAgICAgICBib3QuY29ubmVjdG9yLnN0YXJ0Q29udmVyc2F0aW9uKGJmX21lc3NhZ2UuYWRkcmVzcywgZnVuY3Rpb24oZXJyLCBhZHIpIHtcbiAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgLy8gU2VuZCBtZXNzYWdlIHRocm91Z2ggY29ubmVjdG9yXG4gICAgICAgICAgICBiZl9tZXNzYWdlLmFkZHJlc3MgPSBhZHJcbiAgICAgICAgICAgIGJvdC5jb25uZWN0b3Iuc2VuZChbYmZfbWVzc2FnZV0sIGRvbmUpXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRvbmUoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFNlbmQgbWVzc2FnZSB0aHJvdWdoIGNvbm5lY3RvclxuICAgICAgICBib3QuY29ubmVjdG9yLnNlbmQoW2JmX21lc3NhZ2VdLCBkb25lKVxuICAgICAgfVxuICAgIH1cblxuICAgIGJvdC5yZXBseSA9IGZ1bmN0aW9uKHNyYywgcmVzcCwgY2IpIHtcbiAgICAgIHZhciBtc2cgPSB7fVxuXG4gICAgICBpZiAodHlwZW9mIChyZXNwKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgbXNnLnRleHQgPSByZXNwXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtc2cgPSByZXNwXG4gICAgICB9XG5cbiAgICAgIG1zZy51c2VyID0gc3JjLnVzZXJcbiAgICAgIG1zZy5jaGFubmVsID0gc3JjLmNoYW5uZWxcbiAgICAgIG1zZy5hZGRyZXNzID0gc3JjLmFkZHJlc3NcbiAgICAgIG1zZy50byA9IHNyYy51c2VyXG5cbiAgICAgIGJvdC5zYXkobXNnLCBjYilcbiAgICB9XG5cbiAgICBib3QuZmluZENvbnZlcnNhdGlvbiA9IGZ1bmN0aW9uKG1lc3NhZ2UsIGNiKSB7XG4gICAgICBib3RraXQuZGVidWcoJ0NVU1RPTSBGSU5EIENPTlZPJywgbWVzc2FnZS51c2VyLCBtZXNzYWdlLmNoYW5uZWwpXG4gICAgICBmb3IgKHZhciB0ID0gMDsgdCA8IGJvdGtpdC50YXNrcy5sZW5ndGg7IHQrKykge1xuICAgICAgICBmb3IgKHZhciBjID0gMDsgYyA8IGJvdGtpdC50YXNrc1t0XS5jb252b3MubGVuZ3RoOyBjKyspIHtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICBib3RraXQudGFza3NbdF0uY29udm9zW2NdLmlzQWN0aXZlKCkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvdGtpdC50YXNrc1t0XS5jb252b3NbY10uc291cmNlX21lc3NhZ2UudXNlciA9PSBtZXNzYWdlLnVzZXIgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvdGtpdC50YXNrc1t0XS5jb252b3NbY10uc291cmNlX21lc3NhZ2UuY2hhbm5lbCA9PSBtZXNzYWdlLmNoYW5uZWwgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvdGtpdC5leGNsdWRlZEV2ZW50cy5pbmRleE9mKG1lc3NhZ2UudHlwZSkgPT0gLTEgLy8gdGhpcyB0eXBlIG9mIG1lc3NhZ2Ugc2hvdWxkIG5vdCBiZSBpbmNsdWRlZFxuICAgICAgICAgICkge1xuICAgICAgICAgICAgYm90a2l0LmRlYnVnKCdGT1VORCBFWElTVElORyBDT05WTyEnKVxuICAgICAgICAgICAgY2IoYm90a2l0LnRhc2tzW3RdLmNvbnZvc1tjXSlcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjYigpXG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGNvbm5lY3RvclxuICAgIGJvdC5jb25uZWN0b3IgPSBuZXcgYnVpbGRlci5DaGF0Q29ubmVjdG9yKGNvbmZpZylcblxuICAgIHJldHVybiBib3RcbiAgfSlcblxuICBiZl9ib3RraXQubWlkZGxld2FyZS5ub3JtYWxpemUudXNlKGZ1bmN0aW9uKGJvdCwgbWVzc2FnZSwgbmV4dCkge1xuICAgIC8qXG4gICAgICAgICAqIEJyZWFrIG91dCB1c2VyICYgY2hhbm5lbCBmaWVsZHMgZnJvbSBldmVudFxuICAgICAgICAgKiAtIFRoZXNlIGZpZWxkcyBhcmUgdXNlZCBhcyBrZXlzIGZvciB0cmFja2luZyBjb252ZXJzYXRpb25zIGFuZCBzdG9yYWdlLlxuICAgICAgICAgKiAtIFByZWZpeGluZyB3aXRoIGNoYW5uZWxJZCB0byBlbnN1cmUgdGhhdCB1c2VycyAmIGNoYW5uZWxzIGZvciBkaWZmZXJlbnRcbiAgICAgICAgICogICBwbGF0Zm9ybXMgYXJlIHVuaXF1ZS5cbiAgICAgICAgICovXG5cbiAgICB2YXIgcHJlZml4ID0gbWVzc2FnZS5hZGRyZXNzLmNoYW5uZWxJZCArICc6J1xuICAgIG1lc3NhZ2UudXNlciA9IHByZWZpeCArIG1lc3NhZ2UuYWRkcmVzcy51c2VyLmlkXG4gICAgbWVzc2FnZS5jaGFubmVsID0gcHJlZml4ICsgbWVzc2FnZS5hZGRyZXNzLmNvbnZlcnNhdGlvbi5pZFxuXG4gICAgLy8gTVMgc3VwcGxpZXMgYSB0eXBlIGZpZWxkIHRoYXQgaXMgJ21lc3NhZ2UnIGZvciBtb3N0IG1lc3NhZ2VzLCBidXQgd2Ugd2FudCBpdCB0byBiZSBvdXIgbW9yZSBnZW5lcmljIG1lc3NhZ2VfcmVjZWl2ZWQgZXZlbnRcbiAgICBpZiAobWVzc2FnZS50eXBlID09ICdtZXNzYWdlJykge1xuICAgICAgbWVzc2FnZS50eXBlID0gJ21lc3NhZ2VfcmVjZWl2ZWQnXG4gICAgfVxuXG4gICAgbmV4dCgpXG4gIH0pXG5cbiAgYmZfYm90a2l0Lm1pZGRsZXdhcmUuZm9ybWF0LnVzZShmdW5jdGlvbihib3QsIG1lc3NhZ2UsIHBsYXRmb3JtX21lc3NhZ2UsIG5leHQpIHtcbiAgICAvLyBjbG9uZSB0aGUgaW5jb21pbmcgbWVzc2FnZVxuICAgIGZvciAodmFyIGsgaW4gbWVzc2FnZSkge1xuICAgICAgcGxhdGZvcm1fbWVzc2FnZVtrXSA9IG1lc3NhZ2Vba11cbiAgICB9XG5cbiAgICBuZXh0KClcbiAgfSlcblxuICAvLyBzZXQgdXAgYSB3ZWIgcm91dGUgZm9yIHJlY2VpdmluZyBvdXRnb2luZyB3ZWJob29rcyBhbmQvb3Igc2xhc2ggY29tbWFuZHNcblxuICBiZl9ib3RraXQuY3JlYXRlV2ViaG9va0VuZHBvaW50cyA9IGZ1bmN0aW9uKHdlYnNlcnZlciwgYm90LCBjYikge1xuICAgIC8vIExpc3RlbiBmb3IgaW5jb21pbmcgZXZlbnRzXG4gICAgYmZfYm90a2l0LmxvZyhcbiAgICAgICcqKiBTZXJ2aW5nIHdlYmhvb2sgZW5kcG9pbnRzIGZvciB0aGUgTWljcm9zb2Z0IEJvdCBGcmFtZXdvcmsgYXQ6ICcgK1xuICAgICAgICAgICAgICAgICdodHRwOi8vJyArIGJmX2JvdGtpdC5jb25maWcuaG9zdG5hbWUgKyAnOicgK1xuICAgICAgICAgICAgICAgIGJmX2JvdGtpdC5jb25maWcucG9ydCArICcvYm90ZnJhbWV3b3JrL3JlY2VpdmUnKVxuICAgIHdlYnNlcnZlci5wb3N0KCcvYm90ZnJhbWV3b3JrL3JlY2VpdmUnLCBib3QuY29ubmVjdG9yLmxpc3RlbigpKVxuXG4gICAgLy8gUmVjZWl2ZSBldmVudHMgZnJvbSBjaGF0IGNvbm5lY3RvclxuICAgIGJvdC5jb25uZWN0b3Iub25FdmVudChmdW5jdGlvbihldmVudHMsIGRvbmUpIHtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZhciBiZl9ldmVudCA9IGV2ZW50c1tpXVxuXG4gICAgICAgIGJmX2JvdGtpdC5pbmdlc3QoYm90LCBiZl9ldmVudCwgbnVsbClcbiAgICAgIH1cblxuICAgICAgaWYgKGRvbmUpIHtcbiAgICAgICAgZG9uZShudWxsKVxuICAgICAgfVxuICAgIH0pXG5cbiAgICBpZiAoY2IpIHtcbiAgICAgIGNiKClcbiAgICB9XG5cbiAgICBiZl9ib3RraXQuc3RhcnRUaWNraW5nKClcblxuICAgIHJldHVybiBiZl9ib3RraXRcbiAgfVxuXG4gIHJldHVybiBiZl9ib3RraXRcbn1cblxuZXhwb3J0IGRlZmF1bHQgKHsgc3RvcmFnZSwgbG9nZ2VyIH0pID0+IHtcbiAgY29uc3QgY29udHJvbGxlciA9IEJvdEZyYW1ld29ya0JvdCh7IHN0b3JhZ2UgfSlcbiAgY29uc3QgaW5mbyA9IGxvZ2dlcignY2hhbm5lbHM6Ym90c2VydmljZScsICdpbmZvJylcbiAgY29uc3QgZXJyb3IgPSBsb2dnZXIoJ2NoYW5uZWxzOmJvdHNlcnZpY2UnLCAnZXJyb3InKVxuICByZXR1cm4ge1xuICAgIGNvbnRyb2xsZXIsXG4gICAgbmFtZTogJ2JvdHNlcnZpY2UnLFxuICAgIHN0YXJ0KHsgYXBwIH0pIHtcbiAgICAgIGlmICghcHJvY2Vzcy5lbnYuQVpVUkVfQVBQX0lEIHx8ICFwcm9jZXNzLmVudi5BWlVSRV9BUFBfU0VDUkVUKSB7XG4gICAgICAgIGVycm9yKCdBWlVSRV9BUFBfU0VDUkVUIGFuZCBBWlVSRV9BUFBfSUQgYXJlIHJlcXVpcmVkIGVudiB2YXJzJylcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJvdCA9IGNvbnRyb2xsZXIuc3Bhd24oe1xuICAgICAgICBhcHBJZDogcHJvY2Vzcy5lbnYuQVpVUkVfQVBQX0lELFxuICAgICAgICBhcHBQYXNzd29yZDogcHJvY2Vzcy5lbnYuQVpVUkVfQVBQX1NFQ1JFVFxuICAgICAgfSlcbiAgICAgIGNvbnRyb2xsZXIuY3JlYXRlV2ViaG9va0VuZHBvaW50cyhhcHAsIGJvdClcbiAgICAgIGluZm8oJ0F6dXJlIGJvdCBsaXN0ZW5pbmcnKVxuICAgIH1cbiAgfVxufVxuIl19